{"version":3,"file":"TicketLinksFlyout-D2di-eBe.js","sources":["../../../../../app/frontend/apps/desktop/pages/ticket/graphql/mutations/linkAdd.api.ts","../../../../../app/frontend/apps/desktop/pages/ticket/components/TicketLinksFlyout.vue"],"sourcesContent":["import * as Types from '#shared/graphql/types.ts';\n\nimport gql from 'graphql-tag';\nimport * as VueApolloComposable from '@vue/apollo-composable';\nimport * as VueCompositionApi from 'vue';\nexport type ReactiveFunction<TParam> = () => TParam;\n\nexport const LinkAddDocument = gql`\n    mutation linkAdd($input: LinkInput!) {\n  linkAdd(input: $input) {\n    link {\n      type\n      item {\n        ... on Ticket {\n          id\n          internalId\n          title\n          state {\n            id\n            name\n          }\n          stateColorCode\n        }\n        ... on KnowledgeBaseAnswerTranslation {\n          id\n        }\n      }\n    }\n    errors {\n      message\n      field\n    }\n  }\n}\n    `;\nexport function useLinkAddMutation(options: VueApolloComposable.UseMutationOptions<Types.LinkAddMutation, Types.LinkAddMutationVariables> | ReactiveFunction<VueApolloComposable.UseMutationOptions<Types.LinkAddMutation, Types.LinkAddMutationVariables>> = {}) {\n  return VueApolloComposable.useMutation<Types.LinkAddMutation, Types.LinkAddMutationVariables>(LinkAddDocument, options);\n}\nexport type LinkAddMutationCompositionFunctionResult = VueApolloComposable.UseMutationReturn<Types.LinkAddMutation, Types.LinkAddMutationVariables>;","<!-- Copyright (C) 2012-2025 Zammad Foundation, https://zammad-foundation.org/ -->\n\n<script setup lang=\"ts\">\nimport { computed, toRef } from 'vue'\n\nimport {\n  NotificationTypes,\n  useNotifications,\n} from '#shared/components/CommonNotifications/index.ts'\nimport Form from '#shared/components/Form/Form.vue'\nimport type { FormSubmitData } from '#shared/components/Form/types.ts'\nimport { useForm } from '#shared/components/Form/useForm.ts'\nimport type { TicketById } from '#shared/entities/ticket/types.ts'\nimport { EnumLinkType, type LinkListQuery } from '#shared/graphql/types.ts'\nimport { MutationHandler } from '#shared/server/apollo/handler/index.ts'\n\nimport CommonFlyout from '#desktop/components/CommonFlyout/CommonFlyout.vue'\nimport type { ActionFooterOptions } from '#desktop/components/CommonFlyout/types.ts'\nimport { closeFlyout } from '#desktop/components/CommonFlyout/useFlyout.ts'\nimport TicketRelationAndRecentLists from '#desktop/pages/ticket/components/TicketDetailView/TicketRelationAndRecentLists/TicketRelationAndRecentLists.vue'\nimport { useObjectLinkTypes } from '#desktop/pages/ticket/composables/useObjectLinkTypes.ts'\nimport { useTargetTicketOptions } from '#desktop/pages/ticket/composables/useTargetTicketOptions.ts'\nimport { useLinkAddMutation } from '#desktop/pages/ticket/graphql/mutations/linkAdd.api.ts'\nimport { LinkListDocument } from '#desktop/pages/ticket/graphql/queries/linkList.api.ts'\n\nimport type { Ref } from 'vue'\n\ninterface Props {\n  sourceTicket: Ref<TicketById>\n}\nconst props = defineProps<Props>()\n\nconst sourceTicket = toRef(props, 'sourceTicket')\n\nconst { form, updateFieldValues, onChangedField } = useForm()\n\nconst { formListTargetTicketOptions, targetTicketId, handleTicketClick } =\n  useTargetTicketOptions(onChangedField, updateFieldValues)\n\nconst { linkTypes } = useObjectLinkTypes()\n\nconst linkFormSchema = [\n  {\n    isLayout: true,\n    element: 'div',\n    attrs: {\n      class: 'grid gap-y-2.5 gap-x-3',\n    },\n    children: [\n      {\n        name: 'targetTicketId',\n        type: 'ticket',\n        label: __('Link ticket'),\n        exceptTicketInternalId: sourceTicket.value.internalId,\n        options: formListTargetTicketOptions,\n        clearable: true,\n        required: true,\n      },\n      {\n        name: 'linkType',\n        type: 'select',\n        label: __('Link type'),\n        options: linkTypes,\n      },\n    ],\n  },\n]\n\nconst initialValues = {\n  linkType: EnumLinkType.Normal,\n}\n\nconst footerActionOptions = computed<ActionFooterOptions>(() => ({\n  actionButton: {\n    variant: 'submit',\n    type: 'submit',\n  },\n  actionLabel: __('Link'),\n  form: form.value,\n}))\n\nconst { notify } = useNotifications()\n\nconst addLink = async (\n  formData: FormSubmitData<{\n    targetTicketId: string\n    linkType: EnumLinkType\n  }>,\n) => {\n  const addLinkMutation = new MutationHandler(\n    useLinkAddMutation({\n      variables: {\n        input: {\n          // Don't ask me why, but the sourceId and targetId are swapped to be consistent with the old UI.\n          sourceId: formData.targetTicketId,\n          targetId: sourceTicket.value.id,\n          type: formData.linkType,\n        },\n      },\n      update: (cache, { data }) => {\n        if (!data) return\n\n        const { linkAdd } = data\n        if (!linkAdd?.link) return\n\n        const { link: newLink } = linkAdd\n\n        const variables = {\n          objectId: sourceTicket.value.id,\n          targetType: 'Ticket',\n        }\n\n        let existingLinks = cache.readQuery<LinkListQuery>({\n          query: LinkListDocument,\n          variables,\n        })\n\n        const newIdPresent = existingLinks?.linkList?.find((link) => {\n          return link.item.id === newLink.item.id && link.type === newLink.type\n        })\n        if (newIdPresent) return\n\n        existingLinks = {\n          ...existingLinks,\n          linkList: [...(existingLinks?.linkList || []), newLink],\n        }\n\n        cache.writeQuery({\n          query: LinkListDocument,\n          data: existingLinks,\n          variables,\n        })\n      },\n    }),\n    {\n      errorShowNotification: false,\n    },\n  )\n\n  return addLinkMutation.send().then((data) => {\n    if (data?.linkAdd) {\n      return () => {\n        notify({\n          type: NotificationTypes.Success,\n          message: __('Link added successfully'),\n        })\n\n        closeFlyout('ticket-link')\n      }\n    }\n  })\n}\n</script>\n\n<template>\n  <CommonFlyout\n    :header-title=\"__('Link Tickets')\"\n    header-icon=\"link\"\n    name=\"ticket-link\"\n    size=\"large\"\n    no-close-on-action\n    :footer-action-options=\"footerActionOptions\"\n  >\n    <div class=\"space-y-6\">\n      <Form\n        ref=\"form\"\n        :schema=\"linkFormSchema\"\n        :initial-values=\"initialValues\"\n        should-autofocus\n        @submit=\"\n          addLink(\n            $event as FormSubmitData<{\n              targetTicketId: string\n              linkType: EnumLinkType\n            }>,\n          )\n        \"\n      />\n\n      <TicketRelationAndRecentLists\n        :customer-id=\"sourceTicket.customer.id\"\n        :internal-ticket-id=\"sourceTicket.internalId\"\n        :selected-ticket-id=\"targetTicketId\"\n        @click-ticket=\"handleTicketClick\"\n      />\n    </div>\n  </CommonFlyout>\n</template>\n"],"names":["LinkAddDocument","gql","useLinkAddMutation","options","VueApolloComposable.useMutation","sourceTicket","toRef","__props","form","updateFieldValues","onChangedField","useForm","formListTargetTicketOptions","targetTicketId","handleTicketClick","useTargetTicketOptions","linkTypes","useObjectLinkTypes","linkFormSchema","initialValues","EnumLinkType","footerActionOptions","computed","notify","useNotifications","addLink","formData","MutationHandler","cache","data","linkAdd","newLink","variables","existingLinks","LinkListDocument","_a","link","NotificationTypes","closeFlyout"],"mappings":"46EAOO,MAAMA,EAAkBC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MA4Bf,SAAAC,EAAmBC,EAA2N,GAAI,CACzP,OAAAC,EAAuFJ,EAAiBG,CAAO,CACxH,+FCLM,MAAAE,EAAeC,EAFPC,EAEoB,cAAc,EAE1C,CAAE,KAAAC,EAAM,kBAAAC,EAAmB,eAAAC,GAAmBC,EAAQ,EAEtD,CAAE,4BAAAC,EAA6B,eAAAC,EAAgB,kBAAAC,CACnD,EAAAC,EAAuBL,EAAgBD,CAAiB,EAEpD,CAAE,UAAAO,GAAcC,IAEhBC,EAAiB,CACrB,CACE,SAAU,GACV,QAAS,MACT,MAAO,CACL,MAAO,wBACT,EACA,SAAU,CACR,CACE,KAAM,iBACN,KAAM,SACN,MAAO,GAAG,aAAa,EACvB,uBAAwBb,EAAa,MAAM,WAC3C,QAASO,EACT,UAAW,GACX,SAAU,EACZ,EACA,CACE,KAAM,WACN,KAAM,SACN,MAAO,GAAG,WAAW,EACrB,QAASI,CACX,CACF,CACF,CAAA,EAGIG,EAAgB,CACpB,SAAUC,EAAa,MAAA,EAGnBC,EAAsBC,EAA8B,KAAO,CAC/D,aAAc,CACZ,QAAS,SACT,KAAM,QACR,EACA,YAAa,GAAG,MAAM,EACtB,KAAMd,EAAK,KACX,EAAA,EAEI,CAAE,OAAAe,GAAWC,IAEbC,EAAU,MACdC,GAKwB,IAAIC,EAC1BzB,EAAmB,CACjB,UAAW,CACT,MAAO,CAEL,SAAUwB,EAAS,eACnB,SAAUrB,EAAa,MAAM,GAC7B,KAAMqB,EAAS,QACjB,CACF,EACA,OAAQ,CAACE,EAAO,CAAE,KAAAC,KAAW,OAC3B,GAAI,CAACA,EAAM,OAEL,KAAA,CAAE,QAAAC,CAAY,EAAAD,EAChB,GAAA,EAACC,GAAA,MAAAA,EAAS,MAAM,OAEd,KAAA,CAAE,KAAMC,CAAY,EAAAD,EAEpBE,EAAY,CAChB,SAAU3B,EAAa,MAAM,GAC7B,WAAY,QAAA,EAGV,IAAA4B,EAAgBL,EAAM,UAAyB,CACjD,MAAOM,EACP,UAAAF,CAAA,CACD,GAEoBG,EAAAF,GAAA,YAAAA,EAAe,WAAf,MAAAE,EAAyB,KAAMC,GAC3CA,EAAK,KAAK,KAAOL,EAAQ,KAAK,IAAMK,EAAK,OAASL,EAAQ,QAInDE,EAAA,CACd,GAAGA,EACH,SAAU,CAAC,IAAIA,GAAA,YAAAA,EAAe,WAAY,CAAA,EAAKF,CAAO,CAAA,EAGxDH,EAAM,WAAW,CACf,MAAOM,EACP,KAAMD,EACN,UAAAD,CAAA,CACD,EACH,CAAA,CACD,EACD,CACE,sBAAuB,EACzB,CAAA,EAGqB,KAAA,EAAO,KAAMH,GAAS,CAC3C,GAAIA,GAAA,MAAAA,EAAM,QACR,MAAO,IAAM,CACJN,EAAA,CACL,KAAMc,EAAkB,QACxB,QAAS,GAAG,yBAAyB,CAAA,CACtC,EAEDC,EAAY,aAAa,CAAA,CAE7B,CACD"}