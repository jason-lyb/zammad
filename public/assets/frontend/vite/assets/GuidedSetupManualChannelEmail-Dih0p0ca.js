import{s as W,r as H,w as K,c as S,d as X,f as de,ap as me,m as z,p as ce,u,D as pe,E as fe,U as M,V as O,I as $,q as L,J as be}from"./vue-oicRkvo0.js";import{_ as B}from"./Form.vue_vue_type_script_setup_true_lang-B6L-6HzY.js";import{i as P,r as U}from"./routes-CgLO9M4y.js";import{u as Q}from"./useForm-CUKec4n5.js";import{u as ve}from"./useDebouncedLoading-D3djd3bz.js";import{e as G,M as x,U as q}from"./apollo-Cj5TVUDk.js";import{n as F}from"./vendor-C11O1Xx8.js";import{X as R}from"./overviewAttributes.api-C09LSZ8O.js";import{a as ge,u as he}from"./channelEmailValidateConfigurationOutbound.api-D58S979t.js";import{a as Ee,u as J}from"./useSSLVerificationWarningHandler-CuWTKKwG.js";import{U as D,S as N}from"./date-B2UyDZN7.js";import{_ as _e}from"./GuidedSetupActionFooter.vue_vue_type_script_setup_true_lang-Cze7-cY3.js";import{_ as ye}from"./GuidedSetupStatusMessage.vue_vue_type_script_setup_true_lang-CK-LgkYz.js";import{u as Ce}from"./useSystemSetup-CBS5N4Hd.js";import{e as Ae}from"./emailBeforeRouteEnterGuard-BWQx8J1H.js";import"./formkit-5nol1GBe.js";import"./FormGroup.vue_vue_type_script_setup_true_lang-DIx-HUKU.js";import"./lodash-pFOI14f-.js";import"./vite-FJshFMF2.js";import"./commonjsHelpers-BosuxZz1.js";import"./desktop-l0eJ1dZN.js";import"./useCopyToClipboard-CjkPg__g.js";import"./theme-Bv2ClBzZ.js";import"./datepicker-BBNcWeHz.js";import"./autocompleteTags.api-CG5-cm_A.js";import"./autocompleteSearchTicket.api-DfOQWGlO.js";import"./ticketUpdates.api-BhGIG_Ti.js";import"./ticketAttributes.api-rqx5ITab.js";import"./useTicketCreateArticleType-D7iVcJ_6.js";import"./types-Cu-Nkl7K.js";import"./useTicketCreateView-HCH46SPv.js";import"./LayoutPublicPageBoxActions-BFjF_v1c.js";const Se=()=>{const e=W(),t=[{isLayout:!0,element:"div",attrs:{class:"grid grid-cols-1 gap-y-2.5 gap-x-3"},children:[{name:"realname",label:__("Full name"),type:"text",props:{placeholder:__("Organization Support")},required:!0},{name:"email",label:__("Email address"),type:"email",props:{},validation:"email",required:!0},{name:"password",label:__("Password"),type:"password",props:{},required:!0}]}],{values:c,formSetErrors:p,updateFieldValues:l}=Q(e);return{formEmailAccount:e,emailAccountSchema:t,formEmailAccountValues:c,updateEmailAccountFieldValues:l,formEmailAccountSetErrors:p}},Ie=F`
    mutation channelEmailAdd($input: ChannelEmailAddInput!) {
  channelEmailAdd(input: $input) {
    channel {
      options
      group {
        id
      }
    }
    errors {
      ...errors
    }
  }
}
    ${R}`;function Ve(e={}){return G(Ie,e)}const we=F`
    mutation channelEmailValidateConfigurationRoundtrip($inboundConfiguration: ChannelEmailInboundConfigurationInput!, $outboundConfiguration: ChannelEmailOutboundConfigurationInput!, $emailAddress: String!) {
  channelEmailValidateConfigurationRoundtrip(
    inboundConfiguration: $inboundConfiguration
    outboundConfiguration: $outboundConfiguration
    emailAddress: $emailAddress
  ) {
    success
    errors {
      ...errors
    }
  }
}
    ${R}`;function Me(e={}){return G(we,e)}const Oe=F`
    mutation channelEmailGuessConfiguration($emailAddress: String!, $password: String!) {
  channelEmailGuessConfiguration(emailAddress: $emailAddress, password: $password) {
    result {
      inboundConfiguration {
        adapter
        host
        port
        ssl
        user
        password
        sslVerify
        folder
      }
      outboundConfiguration {
        adapter
        host
        port
        user
        password
        sslVerify
      }
      mailboxStats {
        contentMessages
      }
    }
    errors {
      ...errors
    }
  }
}
    ${R}`;function $e(e={}){return G(Oe,e)}const Le=F`
    mutation channelEmailValidateConfigurationInbound($inboundConfiguration: ChannelEmailInboundConfigurationInput!) {
  channelEmailValidateConfigurationInbound(
    inboundConfiguration: $inboundConfiguration
  ) {
    success
    mailboxStats {
      contentMessages
    }
    errors {
      ...errors
    }
  }
}
    ${R}`;function xe(e={}){return G(Le,e)}const ke=(e,t,c,p)=>{const{loading:l,debouncedLoading:h}=ve(),g=H("account"),E=H(null),s=a=>{if(!h.value){g.value=a;return}E.value=a};K(h,a=>{!a&&E.value&&(g.value=E.value,E.value=null)});const V=S(()=>{switch(g.value){case"inbound":return __("Email Inbound");case"inbound-messages":return __("Archive Emails");case"outbound":return __("Email Outbound");default:return __("Email Account")}}),f=S(()=>{switch(g.value){case"inbound":return e.emailInbound.form.value;case"inbound-messages":return e.emailInboundMessages.form.value;case"outbound":return e.emailOutbound.form.value;default:return e.emailAccount.form.value}}),v=async(a,d,n)=>{var r,_,y;const m=new x(Me()),b=new x(Ve());d.port=Number(d.port),n.port=Number(n.port),(r=t.value)!=null&&r.archive&&(d={...d,archive:!0,archiveBefore:t.value.archiveBefore,archiveStateId:t.value.archiveStateId});try{const i=await m.send({inboundConfiguration:d,outboundConfiguration:n,emailAddress:a.email});if((_=i==null?void 0:i.channelEmailValidateConfigurationRoundtrip)!=null&&_.success)try{const o=await b.send({input:{inboundConfiguration:d,outboundConfiguration:n,emailAddress:a.email,emailRealname:a.realname}});(y=o==null?void 0:o.channelEmailAdd)!=null&&y.channel&&p()}catch(o){e.emailAccount.setErrors(o),s("account")}}catch(i){if(i instanceof q&&Object.keys(i.getFieldErrorList()).length>0){Object.keys(i.getFieldErrorList()).some(o=>o.startsWith("outbound"))?(s("outbound"),e.emailOutbound.setErrors(i)):(s("inbound"),e.emailInbound.setErrors(i));return}e.emailAccount.setErrors(new q([{message:P.t("Email sending and receiving could not be verified. Please check your settings.")}])),s("account")}};return{debouncedLoading:h,stepTitle:V,activeStep:g,activeForm:f,guessEmailAccount:a=>(l.value=!0,new x($e()).send({emailAddress:a.email,password:a.password}).then(async n=>{var m,b,r;if((m=n==null?void 0:n.channelEmailGuessConfiguration)!=null&&m.result.inboundConfiguration&&((b=n==null?void 0:n.channelEmailGuessConfiguration)!=null&&b.result.outboundConfiguration)){const _=n.channelEmailGuessConfiguration.result.inboundConfiguration;delete _.__typename;const y=n.channelEmailGuessConfiguration.result.outboundConfiguration;delete y.__typename,e.emailInbound.updateFieldValues(_),e.emailOutbound.updateFieldValues(y);const i=(r=n==null?void 0:n.channelEmailGuessConfiguration)==null?void 0:r.result.mailboxStats;if(i!=null&&i.contentMessages&&(i==null?void 0:i.contentMessages)>0){c(i,"roundtrip"),s("inbound-messages");return}await v(a,_,y)}else e.emailInbound.updateFieldValues({user:a.email,password:a.password}),e.emailOutbound.updateFieldValues({user:a.email,password:a.password}),e.emailInbound.setErrors(new q([{message:P.t("The server settings could not be automatically detected. Please configure them manually.")}])),s("inbound")}).finally(()=>{l.value=!1})),validateEmailInbound:a=>(l.value=!0,new x(xe()).send({inboundConfiguration:{...a,port:Number(a.port)}}).then(n=>{var m,b;if((m=n==null?void 0:n.channelEmailValidateConfigurationInbound)!=null&&m.success){e.emailOutbound.updateFieldValues({host:a.host,user:a.user,password:a.password});const r=(b=n==null?void 0:n.channelEmailValidateConfigurationInbound)==null?void 0:b.mailboxStats;if(r!=null&&r.contentMessages&&(r==null?void 0:r.contentMessages)>0){c(r,"outbound"),s("inbound-messages");return}s("outbound")}}).finally(()=>{l.value=!1})),importEmailInboundMessages:async a=>{var d,n;t.value&&a.archive&&(t.value.archive=!0,t.value.archiveBefore=a.archive_before,t.value.archiveStateId=a.archive_state_id),((d=t.value)==null?void 0:d.nextAction)==="outbound"&&s("outbound"),((n=t.value)==null?void 0:n.nextAction)==="roundtrip"&&(l.value=!0,await v(e.emailAccount.values.value,e.emailInbound.values.value,e.emailOutbound.values.value),l.value=!1)},validateEmailOutbound:a=>{var n;return l.value=!0,new x(ge()).send({outboundConfiguration:{...a,port:Number(a.port)},emailAddress:(n=e.emailAccount.values.value)==null?void 0:n.email}).then(async m=>{var b;(b=m==null?void 0:m.channelEmailValidateConfigurationOutbound)!=null&&b.success&&await v(e.emailAccount.values.value,e.emailInbound.values.value,e.emailOutbound.values.value)}).finally(()=>{l.value=!1})}}},Be=()=>{const e=W(),{values:t,updateFieldValues:c,formSetErrors:p,onChangedField:l}=Q(e),h=H(null),g=(f,v)=>{h.value={contentMessages:f.contentMessages||0,nextAction:v}},E=S(()=>{const f=[{value:"off",label:__("No SSL")},{value:"ssl",label:__("SSL")}];return t.value.adapter==="imap"&&f.push({value:"starttls",label:__("STARTTLS")}),f}),s=X({sslVerify:{},port:{}});l("ssl",f=>{const v=f==="off";s.sslVerify={disabled:v};const I={sslVerify:!v};f==="off"?I.port=143:f==="ssl"&&(I.port=993),c(I)});const V=[{isLayout:!0,element:"div",attrs:{class:"grid grid-cols-2 gap-y-2.5 gap-x-3"},children:[{type:"group",name:"inbound",isGroupOrList:!0,children:[{name:"adapter",label:__("Type"),type:"select",outerClass:"col-span-2",required:!0},{name:"host",label:__("Host"),type:"text",outerClass:"col-span-2",props:{maxLength:120},required:!0},{name:"user",label:__("User"),type:"text",outerClass:"col-span-2",props:{maxLength:120},required:!0},{name:"password",label:__("Password"),type:"password",outerClass:"col-span-2",props:{maxLength:120},required:!0},{name:"ssl",label:__("SSL/STARTTLS"),type:"select",outerClass:"col-span-1",value:"ssl",options:E},{name:"sslVerify",label:__("SSL verification"),type:"toggle",outerClass:"col-span-1",wrapperClass:"mt-6",value:!0,props:{variants:{true:"yes",false:"no"}}},{name:"port",label:__("Port"),type:"text",outerClass:"col-span-1",validation:"number",props:{maxLength:6},value:993,required:!0},{if:'$values.adapter === "imap"',name:"folder",label:__("Folder"),type:"text",outerClass:"col-span-1",props:{maxLength:120}},{if:'$values.adapter === "imap"',name:"keepOnServer",label:__("Keep messages on server"),type:"toggle",outerClass:"col-span-2",value:!1,props:{variants:{true:"yes",false:"no"}}}]}]}];return{formEmailInbound:e,emailInboundSchema:V,formEmailInboundValues:t,updateEmailInboundFieldValues:c,formEmailInboundSetErrors:p,metaInformationInbound:h,emailInboundFormChangeFields:s,updateMetaInformationInbound:g}},Ge=e=>{const t=W(),c=[{isLayout:!0,element:"div",attrs:{class:"flex flex-col gap-y-2.5 gap-x-3"},children:[{isLayout:!0,component:"CommonLabel",children:'$t("%s email(s) were found in your mailbox. They will all be moved from your mailbox into Zammad.", $metaInformationInbound.contentMessages)'},{isLayout:!0,component:"CommonLabel",children:`$t('You can import some of your emails as an "archive", which means that no notifications are sent and the tickets will be in a target state that you define.')`},{isLayout:!0,component:"CommonLabel",children:'$t("You can find archived emails in Zammad anytime using the search function, like for any other ticket.")'},{name:"archive",label:__("Archive emails"),type:"toggle",value:!0,props:{variants:{true:__("yes"),false:__("no")}}},{name:"archive_before",if:"$values.archive",type:"datetime",label:__("Archive cut-off time"),required:!0,help:__("Emails before the cut-off time are imported as archived tickets. Emails after the cut-off time are imported as regular tickets.")},{name:"archive_state_id",if:"$values.archive",label:__("Archive ticket target state"),type:"select"}]}],p=X({metaInformationInbound:e});return{formEmailInboundMessages:t,emailInboundMessageSchema:c,emailInboundMessageSchemaData:p}},Fe=()=>Ee("archive_before",{key:"archiveBeforeWarning",value:P.t("You have selected a cut-off time in the future. Be aware that all emails (including future ones) are going to be archived until the selected time is reached.")},(e,t)=>!!(t.archive.props.value&&e.props.value&&D(N(e.props.value))),(e,t)=>!!(t.archive.props.value&&(e==null?void 0:e.name)==="archive_before"&&e.newValue&&D(N(e.newValue))),(e,t,c)=>{const{value:p}=e;p&&D(N(p))?t():c()}),Re={class:"flex flex-col gap-2.5"},va=de({beforeRouteEnter:Ae,__name:"GuidedSetupManualChannelEmail",setup(e){const t=me(),{setTitle:c}=Ce(),{formEmailAccount:p,emailAccountSchema:l,formEmailAccountValues:h,formEmailAccountSetErrors:g,updateEmailAccountFieldValues:E}=Se(),{formEmailInbound:s,emailInboundSchema:V,formEmailInboundValues:f,formEmailInboundSetErrors:v,updateEmailInboundFieldValues:I,metaInformationInbound:w,emailInboundFormChangeFields:Y,updateMetaInformationInbound:j}=Be(),{formEmailInboundMessages:a,emailInboundMessageSchema:d,emailInboundMessageSchemaData:n}=Ge(w),{formEmailOutbound:m,emailOutboundSchema:b,formEmailOutboundValues:r,formEmailOutboundSetErrors:_,updateEmailOutboundFieldValues:y,emailOutboundFormChangeFields:i}=he(),{activeStep:o,activeForm:ee,stepTitle:ae,debouncedLoading:Z,guessEmailAccount:ne,validateEmailInbound:oe,validateEmailOutbound:te,importEmailInboundMessages:ue}=ke({emailAccount:{form:p,values:h,updateFieldValues:E,setErrors:g},emailInbound:{form:s,values:f,setErrors:v,updateFieldValues:I},emailInboundMessages:{form:a},emailOutbound:{form:m,values:r,setErrors:_,updateFieldValues:y}},w,j,()=>t.push("/guided-setup/manual/invite"));K(ae,c,{immediate:!0});const k=S(()=>{var T;return o.value==="inbound-messages"&&((T=w.value)==null?void 0:T.nextAction)==="roundtrip"}),ie=()=>{o.value==="inbound"||k.value?o.value="account":o.value==="outbound"&&w.value?o.value="inbound-messages":["outbound","inbound-messages"].includes(o.value)?o.value="inbound":t.push("/guided-setup/manual/channels")},se=S(()=>o.value==="account"?__("Connect and Continue"):o.value==="inbound"||o.value!=="outbound"&&!k.value?__("Continue"):["outbound","inbound-messages"].includes(o.value)?__("Save and Continue"):__("Connect and Continue")),re=S(()=>o.value==="account"?"submit":o.value==="inbound"||o.value!=="outbound"&&!k.value?"primary":"submit"),le=S(()=>o.value==="account"?__("Verifying and saving your configuration…"):o.value==="inbound"||o.value!=="outbound"&&!k.value?__("Verifying your configuration…"):__("Verifying and saving your configuration…"));return(T,C)=>(z(),ce(be,null,[u(Z)?(z(),pe(ye,{key:0,message:le.value},null,8,["message"])):fe("",!0),M($("div",Re,[M($("div",null,[L(B,{id:"channel-email-account",ref_key:"formEmailAccount",ref:p,"form-class":"mb-2.5",schema:u(l),onSubmit:C[0]||(C[0]=A=>u(ne)(A))},null,8,["schema"])],512),[[O,u(o)==="account"]]),M($("div",null,[L(B,{id:"channel-email-inbound",ref_key:"formEmailInbound",ref:s,"form-class":"mb-2.5",handlers:[u(J)()],"flatten-form-groups":["inbound"],"form-updater-id":u(U).FormUpdaterUpdaterGuidedSetupEmailInbound,schema:u(V),"change-fields":u(Y),onSubmit:C[1]||(C[1]=A=>u(oe)(A))},null,8,["handlers","form-updater-id","schema","change-fields"])],512),[[O,u(o)==="inbound"]]),M($("div",null,[L(B,{id:"channel-email-inbound-messages",ref_key:"formEmailInboundMessages",ref:a,"form-class":"mb-2.5",handlers:[u(Fe)()],"form-updater-id":u(U).FormUpdaterUpdaterGuidedSetupEmailArchive,schema:u(d),"schema-data":u(n),onSubmit:C[2]||(C[2]=A=>u(ue)(A))},null,8,["handlers","form-updater-id","schema","schema-data"])],512),[[O,u(o)==="inbound-messages"]]),M($("div",null,[L(B,{id:"channel-email-outbound",ref_key:"formEmailOutbound",ref:m,"form-class":"mb-2.5",handlers:[u(J)()],"flatten-form-groups":["outbound"],"form-updater-id":u(U).FormUpdaterUpdaterGuidedSetupEmailOutbound,schema:u(b),"change-fields":u(i),onSubmit:C[3]||(C[3]=A=>u(te)(A))},null,8,["handlers","form-updater-id","schema","change-fields"])],512),[[O,u(o)==="outbound"]]),L(_e,{form:u(ee),"submit-button-variant":re.value,"submit-button-text":se.value,onGoBack:ie},null,8,["form","submit-button-variant","submit-button-text"])],512),[[O,!u(Z)]])],64))}});export{va as default};
//# sourceMappingURL=GuidedSetupManualChannelEmail-Dih0p0ca.js.map
