import{u as E}from"./useTicketCreateView-HCH46SPv.js";import{l as de,aS as pe,Y as fe,a2 as _e,aT as be,aU as ye}from"./overviewAttributes.api-C09LSZ8O.js";import{u as ke,Q as Te,E as ge}from"./apollo-Cj5TVUDk.js";import{_ as ve,u as Ce,a as he,b as $e,c as Ae,d as Se,e as xe,T as we,f as Ne}from"./CommonDropdown.vue_vue_type_script_setup_true_lang-DOCvnZ_a.js";import{m as d,p as h,z as Le,r as De,c as u,n as Ue,ar as R,a0 as Ie,f as $,D as y,E as q,a1 as S,y as s,I as w,q as b,Q as k,M as T,x as Fe,J as j,ap as Ee,d as B,u as n,X as P}from"./vue-oicRkvo0.js";import{_ as Be}from"./Form.vue_vue_type_script_setup_true_lang-B6L-6HzY.js";import{u as Pe}from"./useForm-CUKec4n5.js";import{u as Re}from"./useTicketSignature-LslYi6X7.js";import{u as qe}from"./useTicketCreate-DQOD5AnJ.js";import{u as je}from"./useTicketCreateArticleType-D7iVcJ_6.js";import{u as Ve}from"./useTicketFormOrganizationHandler-DLoRMaF_.js";import{a as V,e as Qe,q as C,r as ze}from"./routes-CgLO9M4y.js";import{A as Oe,c as x}from"./desktop-l0eJ1dZN.js";import{a as He}from"./LayoutContent.vue_vue_type_script_setup_true_lang-SafgfcNL.js";import{n as Q,q as Ke,u as Me}from"./vendor-C11O1Xx8.js";import{w as Ge,b as Je}from"./lodash-pFOI14f-.js";import"./formkit-5nol1GBe.js";import"./vite-FJshFMF2.js";import"./CommonError.vue_vue_type_script_setup_true_lang-B76hdJ4v.js";import"./LayoutMain.vue_vue_type_script_setup_true_lang-DIWzj6-0.js";import"./ticketAttributes.api-rqx5ITab.js";import"./ticketUpdates.api-BhGIG_Ti.js";import"./index-DwuY2HL4.js";import"./CommonInlineEdit.vue_vue_type_script_setup_true_lang-Blo3VlqB.js";import"./useHtmlLinks-53b5zJaG.js";import"./pwa-THoW_3xc.js";import"./useBaseUrl-BsZiEKQE.js";import"./theme-Bv2ClBzZ.js";import"./useUserDetail-C29_PwWz.js";import"./user.api-BwewaCks.js";import"./ObjectAttributes.vue_vue_type_script_setup_true_lang-B0DrxGTz.js";import"./useDisplayObjectAttributes-sspS-pHp.js";import"./useTicketView-CMOCBKg-.js";import"./useFlyout-KZXqW5RR.js";import"./CommonSectionCollapse.vue_vue_type_script_setup_true_lang-B-hHJAEI.js";import"./LayoutSidebar.vue_vue_type_script_setup_true_lang-BO1pkKrb.js";import"./NavigationMenuList.vue_vue_type_script_setup_true_lang-CYOBePFr.js";import"./useTicketAccountedTime-CSL2Xls9.js";import"./useTicketSubscribe-CmWzZx1x.js";import"./useOrganizationDetail-CenI9U-0.js";import"./dom-0wVl69Vp.js";import"./useAttachments-0IU6Vvzp.js";import"./getAttachmentLinks-Dz1qdLDp.js";import"./FormGroup.vue_vue_type_script_setup_true_lang-DIx-HUKU.js";import"./utils-C-eON4SW.js";import"./useObjectAttributeFormData-BTXeBYyl.js";import"./types-Cu-Nkl7K.js";import"./useCopyToClipboard-CjkPg__g.js";import"./datepicker-BBNcWeHz.js";import"./date-B2UyDZN7.js";import"./autocompleteTags.api-CG5-cm_A.js";import"./autocompleteSearchTicket.api-DfOQWGlO.js";import"./commonjsHelpers-BosuxZz1.js";import"./useResizeGridColumns-CieKHty_.js";const We={},Xe={class:"flex flex-col gap-2.5 rounded-xl border border-neutral-100 bg-neutral-50 p-3 dark:border-gray-900 dark:bg-gray-500"};function Ye(t,a){return d(),h("div",Xe,[Le(t.$slots,"default")])}const Ze=de(We,[["render",Ye]]),et=Q`
    query templates($onlyActive: Boolean = false) {
  templates(onlyActive: $onlyActive) {
    id
    name
  }
}
    `;function tt(t={},a={}){return ke(et,t,a)}const at=Q`
    subscription templateUpdates($onlyActive: Boolean!) {
  templateUpdates(onlyActive: $onlyActive) {
    templates {
      id
      name
    }
  }
}
    `,rt=Ke("ticketTemplate",()=>{const t=De([]),a=r=>{t.value.push(r)},l=V(),c=u(()=>l.hasPermission("ticket.agent")&&t.value.length>0),o=new Te(tt(()=>({onlyActive:!0}),()=>({enabled:c})));o.subscribeToMore({document:at,variables:{onlyActive:!0},updateQuery:(r,{subscriptionData:_})=>{var g;return(g=_.data)!=null&&g.templateUpdates.templates?{templates:_.data.templateUpdates.templates}:null}});const m=o.result(),f=u(()=>{var r;return((r=m.value)==null?void 0:r.templates)||[]});return{usageKeys:t,templateList:f,activate:a,deactivate:r=>{t.value.includes(r)&&Ue(()=>{t.value=Ge(t.value,r)})}}}),ot=()=>{const t=rt(),{templateList:a}=Me(t),{activate:l,deactivate:c}=t,m=R().meta.taskbarTabEntityKey??"apply-template";return l(m),Ie(()=>{c(m)}),{templateList:a}},it=$({__name:"ApplyTemplate",emits:["select-template"],setup(t,{emit:a}){const l=a,{hasPermission:c}=V(),{templateList:o}=ot(),m=u(()=>o&&o.value.length>0&&c("ticket.agent")),f=u(()=>o.value.map(p=>({key:p.id,label:p.name})));return(p,r)=>m.value?(d(),y(ve,{key:0,items:f.value,"action-label":p.$t("Apply Template"),orientation:"top",onHandleAction:r[0]||(r[0]=_=>l("select-template",_.key))},null,8,["items","action-label"])):q("",!0)}}),nt={class:"flex flex-col gap-1.5"},st=$({__name:"TicketDuplicateDetectionAlert",props:{tickets:{}},setup(t){return(a,l)=>{const c=S("CommonLabel"),o=S("CommonLink"),m=S("CommonAlert");return d(),y(m,{variant:"warning"},{default:s(()=>[w("div",nt,[b(c,{class:"text-yellow-600",size:"large"},{default:s(()=>[k(T(a.$c.ticket_duplicate_detection_title),1)]),_:1}),b(c,{class:"text-yellow-600"},{default:s(()=>[k(T(a.$c.ticket_duplicate_detection_body),1)]),_:1}),(d(!0),h(j,null,Fe(a.tickets,([f,p,r])=>(d(),h("ul",{key:f,class:"list-inside list-disc"},[w("li",null,[b(c,{class:"text-yellow-600"},{default:s(()=>[b(o,{link:`/tickets/${f}`,class:"text-yellow-600 !underline"},{default:s(()=>[k(T(p),1)]),_:2},1032,["link"]),k(" "+T(r),1)]),_:2},1024)])]))),128))])]),_:1})}}}),lt={class:"w-full max-w-screen-xl px-28 py-3.5"},ct=$({__name:"TicketCreateContent",props:{tabId:{}},setup(t){const a=Ee(),l=pe(),c=R(),{form:o,isDisabled:m,isDirty:f,isInitialSettled:p,formNodeId:r,values:_,triggerFormUpdater:g}=Pe(),z=u(()=>_.value.title),O=u(()=>_.value.articleSenderType),{currentViewTitle:H}=Oe(z,O);Ce({metaTitle:H});const A=Qe(),K=e=>{if(e){a.replace(`/tickets/${e}`);return}a.replace({name:"Dashboard"})},N=()=>{l.back("/")},{ticketArticleSenderTypeField:M}=je(),{createTicket:G,isTicketCustomer:J}=qe(o,K),W=__("New Ticket"),X=fe([{isLayout:!0,component:"CommonContentPanel",children:[{isLayout:!0,element:"h1",attrs:{class:"py-2.5 text-center text-xl font-medium leading-snug text-black dark:text-white",ariaCurrent:"page"},children:"$values.title || $t($defaultTitle)"},{if:"$isTicketCustomer === false",...M,outerClass:"flex justify-center"},{isLayout:!0,element:"div",attrs:{class:"grid grid-cols-1 gap-2.5",role:"tabpanel",ariaLabelledby:"$getTabLabel($values.articleSenderType)",id:"$getTabPanelId($values.articleSenderType)"},children:[{if:"$existingAdditionalCreateNotes() && $getAdditionalCreateNote($values.articleSenderType) !== undefined",isLayout:!0,component:"CommonAlert",props:{variant:"warning"},children:"$t($getAdditionalCreateNote($values.articleSenderType))"},{if:"$values.ticket_duplicate_detection.count > 0",isLayout:!0,component:"TicketDuplicateDetectionAlert",props:{tickets:"$values.ticket_duplicate_detection.items"},children:""},{screen:"create_top",object:C.Ticket},{if:'$values.articleSenderType === "email-out"',name:"cc",label:__("CC"),type:"recipient",props:{multiple:!0,clearable:!0}},{if:'$securityIntegration === true && $values.articleSenderType === "email-out"',name:"security",label:__("Security"),type:"security"},{name:"body",screen:"create_top",object:C.TicketArticle,required:!0,props:{meta:{mentionText:{customerNodeName:"customer_id",groupNodeName:"group_id"},mentionUser:{groupNodeName:"group_id"},mentionKnowledgeBase:{attachmentsNodeName:"attachments"}}}},{type:"file",name:"attachments",label:__("Attachment"),labelSrOnly:!0,props:{multiple:!0}},{name:"ticket_duplicate_detection",type:"hidden",value:{count:0,items:[]}},{name:"link_ticket_id",type:"hidden"},{name:"shared_draft_id",type:"hidden"},{name:"externalReferences",type:"hidden"}]}]},{isLayout:!0,component:"CommonContentPanel",children:[{isLayout:!0,element:"div",attrs:{class:"grid grid-cols-2-uneven gap-2.5"},children:[{screen:"create_middle",object:C.Ticket}]},{screen:"create_bottom",object:C.Ticket}]}]),Y=u(()=>(A.config.smime_integration||A.config.pgp_integration)??!1),L=u(()=>A.config.ui_ticket_create_notes||{}),Z=B({defaultTitle:W,isTicketCustomer:J,securityIntegration:Y,getTabLabel:e=>`tab-label-${e}`,getTabPanelId:e=>`tab-panel-${e}`,existingAdditionalCreateNotes:()=>Object.keys(L).length>0,getAdditionalCreateNote:e=>L.value[e]}),ee=B({body:{required:!0}}),{signatureHandling:te}=Re(),ae=u(e=>{if(!p.value)return{};const i={formValues:_.value,formIsDirty:f.value};return e&&Je(i,e)?e:i}),{currentTaskbarTab:re,currentTaskbarTabId:D,currentTaskbarTabFormId:oe,currentTaskbarTabDelete:U}=he(ae),{setSkipNextStateUpdate:I}=$e(D,o,g),F=u(()=>({screenType:we.TicketCreate,form:o.value,formValues:_.value,currentTaskbarTabId:D}));Ae(F);const{hasSidebar:ie}=Se(),{waitForVariantConfirmation:ne}=_e(),se=async()=>{await ne("unsaved")&&(N(),U())},le=e=>{I(!0),g({includeDirtyFields:!0,additionalParams:{templateId:e}})},ce=u(()=>{var e;return{taskbarId:(e=re.value)==null?void 0:e.taskbarTabId,...c.query||{}}}),me=async e=>G(e).then(i=>{!i||i===null||i===void 0||(typeof i=="function"&&i(),U())});return(e,i)=>(d(),y(He,{name:"ticket-create","background-variant":"primary","content-alignment":"center","show-sidebar":n(ie)},{sideBar:s(({isCollapsed:v,toggleCollapse:ue})=>[b(xe,{context:F.value,"is-collapsed":v,"toggle-collapse":ue},null,8,["context","is-collapsed","toggle-collapse"])]),bottomBar:s(()=>[n(p)?(d(),h(j,{key:0},[n(f)?(d(),y(x,{key:0,size:"large",variant:"danger",disabled:n(m),onClick:se},{default:s(()=>[k(T(e.__("Discard Changes")),1)]),_:1},8,["disabled"])):(d(),y(x,{key:1,size:"large",variant:"secondary",onClick:N},{default:s(()=>[k(T(e.__("Cancel & Go Back")),1)]),_:1}))],64)):q("",!0),b(it,{onSelectTemplate:le}),b(x,{size:"large",variant:"submit",type:"submit",form:n(r),disabled:n(m)},{default:s(()=>[k(T(e.__("Create")),1)]),_:1},8,["form","disabled"])]),default:s(()=>[w("div",lt,[(d(),y(Be,{id:"ticket-create",ref_key:"form",ref:o,key:e.tabId,"form-id":n(oe),schema:n(X),"schema-component-library":{CommonContentPanel:P(Ze),TicketDuplicateDetectionAlert:P(st)},"schema-data":Z,"form-updater-id":n(ze).FormUpdaterUpdaterTicketCreate,handlers:[n(Ve)(),n(te)("body")],"change-fields":ee,"form-updater-additional-params":ce.value,"use-object-attributes":"","form-class":"flex flex-col gap-3",onSubmit:i[0]||(i[0]=v=>me(v)),onChanged:i[1]||(i[1]=v=>n(I)(!0))},null,8,["form-id","schema","schema-component-library","schema-data","form-updater-id","handlers","change-fields","form-updater-additional-params"]))])]),_:1},8,["show-sidebar"]))}}),ma=$({beforeRouteEnter(t){const{ticketCreateEnabled:a,checkUniqueTicketCreateRoute:l}=E();return a.value?l(t):be({type:ye.AuthenticatedError,title:__("Forbidden"),message:__("Creating new tickets via web is disabled."),statusCode:ge.Forbidden})},beforeRouteUpdate(t){const{checkUniqueTicketCreateRoute:a}=E();return a(t)},__name:"TicketCreate",props:{tabId:{}},setup(t){return(a,l)=>(d(),y(Ne,null,{default:s(()=>[b(ct,{"tab-id":a.tabId},null,8,["tab-id"])]),_:1}))}});export{ma as default};
//# sourceMappingURL=TicketCreate-DEsA7qAs.js.map
