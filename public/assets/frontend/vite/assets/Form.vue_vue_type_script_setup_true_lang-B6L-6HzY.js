import{c as O,f as He,m as X,p as pe,z as Y,H as ve,d as Pe,j as ut,r as V,t as _e,ag as ft,a7 as dt,X as W,s as mt,ah as pt,w as J,a3 as vt,a0 as gt,a1 as ht,u as _,q as de,E as De,D as bt,y as Ft,C as yt,J as jt,n as M,U as It,V as Ut,I as Ot}from"./vue-oicRkvo0.js";import{g as me,L as St,M as At,N as kt,a as $t}from"./formkit-5nol1GBe.js";import{u as Et,g as Te,Q as Vt,c as Ct,N as xe}from"./apollo-Cj5TVUDk.js";import{aw as wt,ax as Lt,at as Bt,ay as Pt,m as _t,az as k,aA as Dt,aB as Tt,am as xt,an as Kt,aC as zt,aD as Mt,aE as Gt,aF as Ht}from"./overviewAttributes.api-C09LSZ8O.js";import{i as Qt,t as Ke}from"./routes-CgLO9M4y.js";import{_ as Wt}from"./FormGroup.vue_vue_type_script_setup_true_lang-DIx-HUKU.js";import{n as Jt,l as Xt}from"./vendor-C11O1Xx8.js";import{i as ze,b as Me,j as Yt,o as Zt,a as Ge}from"./lodash-pFOI14f-.js";const Nt=(I=[])=>{const{getObjectAttributesForObject:b}=wt(),$=(h,S,A)=>{var C;const F=b(S),U=F.formFieldAttributesLookup.get(h);if(!A)return U;const y=(C=F.attributesLookup.get(h))==null?void 0:C.screens[A];return U&&y&&Lt(y,U),U};return{getFormFieldSchema:$,getFormFieldsFromScreen:(h,S)=>{const A=b(S).screens;if(!A[h])return[];const F=[];return A[h].forEach(U=>{if(I.includes(U))return;const y=$(U,S,h);y&&F.push(y)}),F}}},Rt=I=>{const b={};return I.forEach(n=>{b[n]=Bt(n)}),{objectAttributesLoading:O(()=>{let n=!1;return Object.keys(b).forEach(S=>{b[S].formFieldAttributesLookup.value.size===0&&(n=!0)}),n})}},qt=He({__name:"FormLayout",props:{columns:{default:1}},setup(I){const b=I,$=O(()=>`column-${b.columns}`);return(n,h)=>(X(),pe("fieldset",{class:ve(["flex flex-wrap",$.value])},[Y(n.$slots,"default")],2))}}),ea=Jt`
    query formUpdater($formUpdaterId: EnumFormUpdaterId!, $meta: FormUpdaterMetaInput!, $data: JSON!, $relationFields: [FormUpdaterRelationField!]!, $id: ID) {
  formUpdater(
    formUpdaterId: $formUpdaterId
    meta: $meta
    data: $data
    relationFields: $relationFields
    id: $id
  ) {
    fields
    flags
  }
}
    `;function ta(I,b={}){return Et(ea,I,b)}const aa={key:0,class:"flex items-center justify-center"},sa={inheritAttrs:!1},da=He({...sa,__name:"Form",props:{id:{},schema:{default:()=>[]},schemaData:{},schemaComponentLibrary:{},handlers:{},changeFields:{default:()=>Pe({})},formId:{},formUpdaterId:{},formUpdaterInitialOnly:{type:Boolean},formUpdaterAdditionalParams:{},flattenFormGroups:{},formKitPlugins:{},formKitSectionsSchema:{},class:{},formClass:{},initialValues:{},initialEntityObject:{},validationVisibility:{default:Pt.Submit},disabled:{type:Boolean},shouldAutofocus:{type:Boolean},useObjectAttributes:{type:Boolean,default:!1},objectAttributeSkippedFields:{},clearValuesAfterSubmit:{type:Boolean},onSubmit:{}},emits:["changed","node","settled","focused"],setup(I,{expose:b,emit:$}){const n=I,h=n.formId?n.formId:Te(),S=ut(),A=O(()=>!!S.default||!!n.schema),F=V(!1);A.value||Xt.error("No schema defined. Please use the schema prop or the default slot for the schema.");const U=_e(n,"class"),y=$,C=V(!1),ge=ft(C,300),E=V(!1),he=V(!1),Z=V(!1),f=V(),Qe=dt("form"),w=_e(n,"changeFields"),D=new Set,N=new Map,L=e=>Dt(h,e),R=e=>{var t;return(t=f.value)==null?void 0:t.find(e,"name")},be=e=>{M(()=>{var r;const t=xt(Qe.value);t==null||t.focus(),t==null||t.scrollIntoView({block:"nearest"});const a=((r=e.context)==null?void 0:r.id)||e.name;Ke.set(`${a}.focused`),y("focused")})},Fe=(e,t=n.initialEntityObject)=>{e.context&&t&&(e.context.initialEntityObject=t)},We=e=>{f.value=e,Fe(e),e.settled.then(()=>{C.value=!1,M(()=>{var a;N.forEach((r,i)=>{var l;(l=R(i))==null||l.input(r,!1)}),N.clear(),E.value=!0,D.clear();const t=((a=e.context)==null?void 0:a.id)||e.name;Ke.set(`${t}.settled`),y("settled"),he.value=!0,Q(k.InitialSettled,B.value),n.shouldAutofocus&&be(e)})}),e.on("autofocus",()=>be(e)),y("node",e)},q=O(()=>{var e;return(e=f.value)==null?void 0:e.context}),ye=(e,t)=>{const a={...e};return t.forEach(r=>{Object.assign(a,a[r]),delete a[r]}),a},B=O(()=>q.value?n.flattenFormGroups?ye(q.value.value,n.flattenFormGroups):q.value.value:{}),ee=[],te={},je=O(()=>{var e,t;return!!((t=(e=f.value)==null?void 0:e.context)!=null&&t.state.formUpdaterProcessing)}),Je=O(()=>{var e,t;return!!((t=(e=f.value)==null?void 0:e.context)!=null&&t.state.uploadProcessing)});let ae=!1;const Xe=()=>{(je.value||Je.value)&&(ae=!0)},Ie=e=>{f.value&&(n.clearValuesAfterSubmit?f.value.reset():f.value.reset(e))},Ue=(e,t)=>{var a;if(f.value){if(p.flags={},Zt(e)&&("reset"in e||"finally"in e)){e.reset?e.reset(t,f.value.value):Ie(t),(a=e.finally)==null||a.call(e);return}Ie(t),typeof e=="function"&&e()}},Ye=e=>{var r;if(!n.onSubmit)return;const t=n.flattenFormGroups?ye(e,n.flattenFormGroups):e;(r=f.value)==null||r.clearErrors();const a=n.onSubmit(t,p.flags);if(!(a!==void 0&&a===!1)){if(a instanceof Promise)return a.then(i=>{var l;i!==void 0&&i===!1||!f.value||(l=f.value.context)!=null&&l.state.errors||Ue(i,e)}).catch(i=>{f.value&&Tt(f.value,i)});Ue(a,e)}};let G;const Ze=e=>{oe("manual",void 0,void 0,e)},Ne=e=>(e.on("message-removed",async({payload:t})=>{(t.key==="formUpdaterProcessing"||t.key==="uploadProcessing")&&ae&&setTimeout(()=>{ae=!1,e.submit()},0)}),!1),Re=O(()=>[Ne,...n.formKitPlugins||[]]),qe=O(()=>({validationVisibility:n.validationVisibility})),Oe={FormLayout:W(qt),FormGroup:W(Wt),...n.schemaComponentLibrary},se=V([]),re=[],p=Pe({fields:{},flags:{},values:B,t:(e,...t)=>Qt.t(e,...t),markup:_t,...n.schemaData}),Se={},Ae=e=>{if(e){if(e.internalId)return e.internalId;if(e.id)return Gt(e.id).id}};let ie={};const ke=(e=n.initialEntityObject)=>{if(ze(e))return;const{objectAttributeValues:t}=e;t&&(ie=t.reduce((a,r)=>{const{attribute:i}=r;return!i||!i.name||(a[i.name]=r.value),a},{})||{})};ke();const $e=(e,t=n.initialEntityObject)=>{if(ze(t))return;let a;if(te[e]){const r=t[te[e]];if(!r)return;"edges"in r?a=Kt(r).map(i=>Ae(i)):a=Ae(r)}if(!a){const r=Se[e]||e;a=r in ie?ie[r]:t[r]}return a},et=(e,t,a,r,i=!0)=>{const l={},s=[],o={},c=(u,d,v)=>{if(v){l[v]||(l[v]={}),l[v][u]=d;return}l[u]=d},m=(u,d,v)=>{if(u in d)return c(u,d[u],v),!0;if(v&&v in d&&d[v]){const j=d[v][u];return c(u,j,v),!0}return!1},g=(u,d,v)=>{const j=$e(u,d);return j!==void 0?(c(u,j,v),!0):!1};return Object.entries(p.fields).forEach(([u,{props:d}])=>{var Be;const v=d.id?me(d.id):L(d.name);if(!v)return;let j="";v.parent&&v.parent.name!==e.name&&(j=v.parent.name);const Le=r==null?void 0:r.name;if(Le){if(j!==Le)return;j=""}!i&&((Be=v.context)!=null&&Be.state.dirty)&&(s.push(v),o[u]=v._value),!(t&&m(u,t,j))&&a&&g(u,a,j)}),{dirtyNodes:s,dirtyValues:o,resetValues:l}},tt=(e={},t={})=>{var u;if(!f.value)return;const{object:a,values:r}=e,{resetDirty:i=!0,resetFlags:l=!0,groupNode:s}=t;Z.value=!0,l&&(p.flags={});const o=f.value;a&&(ke(a),Fe(o,a));const{dirtyNodes:c,dirtyValues:m,resetValues:g}=et(o,r,a,s,i);(u=s||o)==null||u.reset(Object.keys(g).length?g:void 0),c.forEach(d=>{d.input(m[d.name],!1)}),Z.value=!1,oe(i?"form-reset":"form-refresh")},P={...n.initialValues},at=(e,t,a)=>{t&&ee.push({name:e,relation:t.type,filterIds:t.filterIds}),a&&(te[e]=a)},st=(e,t)=>{t&&(Se[e]=zt(e))},rt=(e,t)=>{var i;const r=(((i=n.initialEntityObject)==null?void 0:i.objectAttributeValues)||[]).find(({attribute:l})=>l.name===t);r!=null&&r.renderedLink&&(e.link=r.renderedLink)},T=e=>{var m,g;const{show:t,updateFields:a,relation:r,if:i,props:l={},...s}=e,o=!!(i||(m=p.fields[e.name])!=null&&m.staticCondition),c=t??((g=p.fields[e.name])==null?void 0:g.show)??(o?void 0:!0);if("disabled"in s&&!s.disabled&&(s.disabled=void 0),rt(s,e.name),p.fields[e.name])p.fields[e.name]={show:c,updateFields:!!a,staticCondition:o,props:Object.assign(p.fields[e.name].props,s,l)};else{at(e.name,r,l==null?void 0:l.belongsToObjectField),st(e.name,!!s.internal);const u=Object.assign(s,l);if(e.name in P)u.value=P[e.name];else{const d=$e(e.name);u.value=d!==void 0?d:u.value}P[e.name]=u.value,p.fields[e.name]={show:c,updateFields:!!a,staticCondition:o,props:u}}},H=e=>{const t=(a,r,i,l)=>{r!==void 0&&(i?l.value=r:E.value||N.set(a,r))};Object.keys(e).forEach(async a=>{var g,u;if(!p.fields[a])return;const{initialValue:r,value:i,...l}=e[a],s={...l,name:a},o=!p.fields[a].show&&s.show,c=p.fields[a].staticCondition,m=!o&&i!==void 0&&!Me(i,B.value[a]);if(m&&(s.pendingValueUpdate=!0),t(a,i??r,o||r!==void 0||c&&!L(a),s),E.value&&!p.fields[a].show&&s.show&&!((g=f.value)!=null&&g.isSettled)&&await((u=f.value)==null?void 0:u.settled),D.add(a),T(s),!!E.value&&m){const d=s.id?me(s.id):L(a);M(()=>{d==null||d.input(i,!1)})}}),M(()=>{var a;D.clear(),(a=f.value)==null||a.store.remove("formUpdaterProcessing")})},ne={[k.Initial]:[],[k.InitialSettled]:[],[k.FieldChange]:[]};n.handlers&&n.handlers.forEach(e=>{Object.values(k).forEach(t=>{e.execution.includes(t)&&ne[t].push(e.callback)})});const Q=(e,t,a,r)=>{ne[e].length!==0&&ne[e].forEach(i=>{i(e,{changeFields:w,updateSchemaDataField:T,schemaData:p},{formNode:f.value,getNodeByName:L,findNodeByName:R,values:t,changedField:a,initialEntityObject:n.initialEntityObject,formUpdaterData:r})})},x=mt();let K;const Ee=()=>{var e;K&&((e=f.value)==null||e.store.set($t({blocking:!0,key:"formUpdaterProcessing",value:!0,visible:!1})),x.value=K,K=null)},oe=(e,t,a,r)=>{var s,o;if(!n.formUpdaterId||!G||e!=="manual"&&e!=="form-reset"&&e!=="form-refresh"&&(!t||n.formUpdaterInitialOnly))return;const i={requestId:Te(),formId:h,additionalData:{...n.formUpdaterAdditionalParams,...r==null?void 0:r.additionalParams}};if(r!=null&&r.includeDirtyFields){const c=[];Object.entries(p.fields).forEach(([m,{props:g}])=>{var d;const u=g.id?me(g.id):L(g.name);u&&(d=u.context)!=null&&d.state.dirty&&c.push(m)}),i.dirtyFields=c}const l={...B.value};if(e==="form-reset")i.reset=!0;else if(t){i.changedField=t;const c=(s=a==null?void 0:a.parent)==null?void 0:s.name;f.value&&c&&c!==f.value.name&&(!n.flattenFormGroups||!n.flattenFormGroups.includes(c))?(l[c]||(l[c]={}),l[c][t.name]=t.newValue):l[t.name]=t.newValue}K=W({id:(o=n.initialEntityObject)==null?void 0:o.id,formUpdaterId:n.formUpdaterId,data:l,meta:i,relationFields:ee}),e!=="blur"&&Ee()},le=new WeakMap,it=e=>(e.on("commit",({payload:t,origin:a})=>{var i;const r=le.get(a);if(!Me(t,r)){if(!E.value||Z.value){le.set(a,Ge(t));return}e.props.triggerFormUpdater&&!D.has(a.name)&&oe(e.props.formUpdaterTrigger,{name:a.name,newValue:t,oldValue:r},a),y("changed",a.name,t,r),(i=f.value)==null||i.emit(`changed:${a.name}`,{newValue:t,oldValue:r,fieldNode:a}),Q(k.FieldChange,B.value,{name:a.name,newValue:t,oldValue:r}),le.set(a,Ge(t)),D.delete(a.name)}}),e.on("blur",async()=>{var t,a;e.props.formUpdaterTrigger==="blur"&&((t=f.value)!=null&&t.isSettled||await((a=f.value)==null?void 0:a.settled),K&&Ee())}),e.hook.message((t,a)=>(t.key==="submitted"&&je.value&&(t.value=!1),a(t))),!1),nt=()=>{const{getFormFieldSchema:e,getFormFieldsFromScreen:t}=Nt(re),a=s=>{const o=s.id||Ht(h,s.name),c=[it];return s.plugins&&c.push(...s.plugins),{$cmp:"FormKit",if:s.if?s.if:`$fields.${s.name}.show`,bind:`$fields.${s.name}.props`,props:{type:s.type,key:o,name:s.name,id:o,formId:h,plugins:c,validationMessages:s.validationMessages,validationRules:s.validationRules,triggerFormUpdater:s.triggerFormUpdater??!!n.formUpdaterId}}},r=s=>{let o;return"component"in s?o={$cmp:s.component,...s.if&&{if:s.if},props:s.props}:o={$el:s.element,...s.if&&{if:s.if},attrs:s.attrs},s.if&&(o.if=s.if),o},i=s=>{if("isLayout"in s&&s.isLayout)return r(s);if("isGroupOrList"in s&&s.isGroupOrList){const o=`${s.name}-${h}`;return{$cmp:"FormKit",...s.if&&{if:s.if},props:{type:s.type,name:s.name,id:o,key:s.name,plugins:s.plugins}}}if("object"in s&&e&&t){if("name"in s&&s.name&&!s.type){const{screen:o,object:c,...m}=s,g=e(m.name,c,o);if(!g)return null;s={...g,...m}}else if("screen"in s&&!("name"in s)){const o=t(s.screen,s.object),c=[];return o.forEach(m=>{T(m),c.push(a(m))}),c}}return T(s),a(s)},l=(s=n.schema)=>s.reduce((o,c)=>{if(typeof c=="string")return o.push(c),o;const m=i(c);if(!m)return o;if("children"in c){const g=Array.isArray(c.children)?[...l(c.children)]:c.children;return o.push({...m,children:g}),o}return Array.isArray(m)?o.push(...m):o.push(m),o},[]);se.value=l()};pt(E,()=>{J(w,e=>{H(e)},{deep:!0})}),J(()=>n.schemaData,()=>Object.assign(p,n.schemaData),{deep:!0});const Ve=()=>{F.value||(F.value=!0)},{notify:Ce,removeNotification:ot}=Ct();let z;const we=()=>{z&&(clearTimeout(z),z=null)},ce=()=>{ot("form-updater-autosave"),we()},lt=()=>{var t,a,r,i;if(!((a=(t=x.value)==null?void 0:t.meta.additionalData)!=null&&a.taskbarId)&&!((i=(r=x.value)==null?void 0:r.meta.additionalData)!=null&&i.applyTaskbarState))return;ce();const e=G.loading();J(e,l=>{if(!l){ce();return}we(),z=setTimeout(()=>{Ce({id:"form-updater-autosave",message:__("Autosave in progress…"),type:xe.Info,persistent:!0}),z=setTimeout(()=>{Ce({id:"form-updater-autosave",message:__("Autosaving is taking longer than expected…"),type:xe.Warn,persistent:!0})},4e3)},1e3)})},ue=vt();gt(()=>{ue.active&&ue.stop(),ce()});const fe=()=>{var e;nt(),n.formUpdaterId?(x.value=W({id:(e=n.initialEntityObject)==null?void 0:e.id,formUpdaterId:n.formUpdaterId,data:P,meta:{initial:!0,additionalData:n.formUpdaterAdditionalParams,formId:h},relationFields:ee}),ue.run(()=>{G=new Vt(ta(x,{context:{batch:{active:!1},websocket:{active:!0}},fetchPolicy:"no-cache"}))}),lt(),G.onResult(t=>{var a,r;F.value||Q(k.Initial,P,void 0,(a=t==null?void 0:t.data)==null?void 0:a.formUpdater),(r=t==null?void 0:t.data)!=null&&r.formUpdater&&(Object.assign(p.flags,t.data.formUpdater.flags),H(w.value?Yt(t.data.formUpdater.fields,w.value):t.data.formUpdater.fields)),Ve()})):(Q(k.Initial,P),w.value&&H(w.value),Ve())};if(n.schema)if(C.value=!0,n.useObjectAttributes){n.objectAttributeSkippedFields&&re.push(...n.objectAttributeSkippedFields);const e=[],t=r=>{e.includes(r)||e.push(r)},a=(r=n.schema)=>{r.forEach(i=>{typeof i!="string"&&("object"in i&&("name"in i&&i.name&&!i.type&&re.push(i.name),t(i.object)),"children"in i&&Array.isArray(i.children)&&a(i.children))})};if(a(),e.length>0){const{objectAttributesLoading:r}=Rt(e),i=J(r,l=>{l||(M(()=>i()),fe())},{immediate:!0})}else fe()}else fe();const ct=Mt();return b({formNode:f,formInitialSettled:he,formId:h,values:B,flags:p.flags,updateChangedFields:H,updateSchemaDataField:T,getNodeByName:L,findNodeByName:R,resetForm:tt,triggerFormUpdater:Ze}),(e,t)=>{const a=ht("CommonIcon");return X(),pe(jt,null,[_(ge)?(X(),pe("div",aa,[de(a,{class:ve(_(ct).loading),name:"loading",animation:"spin"},null,8,["class"])])):De("",!0),A.value&&(F.value&&Object.keys(p.fields).length>0||e.$slots.default)?(X(),bt(_(kt),yt({key:1},e.$attrs,{id:e.id,type:"form",novalidate:"",config:qe.value,"form-class":U.value,actions:!1,"incomplete-message":!1,plugins:Re.value,"sections-schema":e.formKitSectionsSchema,disabled:e.disabled,onNode:We,onSubmit:Ye,onSubmitRaw:Xe}),{default:Ft(()=>[de(_(St),{"sections-schema":{messages:{$el:"div"},message:{$el:void 0,$cmp:"CommonAlert",props:{id:"$id + '-' + $message.key",key:"$message.key",variant:{if:"$message.type == error || $message.type == validation",then:"danger",else:"$message.type"}},slots:{default:"$message.value"}}}}),Y(e.$slots,"before-fields"),Y(e.$slots,"default",{schema:se.value,data:p,library:Oe},()=>[It(Ot("div",{ref:"form",class:ve(e.formClass)},[de(_(At),{schema:se.value,data:p,library:Oe},null,8,["schema","data"])],2),[[Ut,E.value&&!_(ge)]])]),Y(e.$slots,"after-fields")]),_:3},16,["id","config","form-class","plugins","sections-schema","disabled"])):De("",!0)],64)}}});export{da as _};
//# sourceMappingURL=Form.vue_vue_type_script_setup_true_lang-B6L-6HzY.js.map
