{"version":3,"file":"FieldTagsDialog-2uaAZUZY.js","sources":["../../../../../app/frontend/apps/mobile/components/Form/fields/FieldTags/FieldTagsDialog.vue"],"sourcesContent":["<!-- Copyright (C) 2012-2025 Zammad Foundation, https://zammad-foundation.org/ -->\n\n<script setup lang=\"ts\">\nimport { watchIgnorable } from '@vueuse/shared'\nimport { computed, ref, toRef } from 'vue'\n\nimport type { CommonInputSearchExpose } from '#shared/components/CommonInputSearch/CommonInputSearch.vue'\nimport CommonInputSearch from '#shared/components/CommonInputSearch/CommonInputSearch.vue'\nimport {\n  NotificationTypes,\n  useNotifications,\n} from '#shared/components/CommonNotifications/index.ts'\nimport useValue from '#shared/components/Form/composables/useValue.ts'\nimport type { FieldTagsContext } from '#shared/components/Form/fields/FieldTags/types.ts'\nimport { useTraverseOptions } from '#shared/composables/useTraverseOptions.ts'\nimport { useAutocompleteSearchTagQuery } from '#shared/entities/tags/graphql/queries/autocompleteTags.api.ts'\nimport { QueryHandler } from '#shared/server/apollo/handler/index.ts'\nimport stopEvent from '#shared/utils/events.ts'\n\nimport CommonDialog from '#mobile/components/CommonDialog/CommonDialog.vue'\n\ninterface Props {\n  name: string\n  context: FieldTagsContext\n}\n\nconst props = defineProps<Props>()\nconst { localValue } = useValue(toRef(props, 'context'))\nconst currentValue = computed<string[]>(() => localValue.value || [])\nconst isCurrentValue = (tag: string) => currentValue.value.includes(tag)\n\nconst filter = ref('')\nconst newTags = ref<{ value: string; label: string }[]>([])\n\nconst tagsQuery = new QueryHandler(\n  useAutocompleteSearchTagQuery(() => ({ input: { query: filter.value } }), {\n    debounce: 300,\n  }),\n)\n\nconst autocompleteTags = computed(() => {\n  const result = tagsQuery.result()\n  return result.value?.autocompleteSearchTag || []\n})\n\nconst filterInput = ref<CommonInputSearchExpose>()\nconst tagsListbox = ref<HTMLElement>()\n\nconst sortedOptions = computed(() => {\n  const { sorting = 'label' } = props.context\n\n  const allOptions = [...autocompleteTags.value, ...newTags.value]\n    .sort((a, b) => {\n      const a1 = (a[sorting] || '').toString()\n      const b1 = (b[sorting] || '').toString()\n      return a1.localeCompare(b1)\n    })\n    .map((tag) => tag.label)\n\n  return Array.from(new Set(allOptions))\n})\n\nconst tagExists = (tag: string) => {\n  return sortedOptions.value.some((option) => option === tag)\n}\n\nconst { ignoreUpdates } = watchIgnorable(\n  currentValue,\n  (newValue) => {\n    newValue.forEach((tag) => {\n      if (!tagExists(tag)) {\n        newTags.value.push({ value: tag, label: tag })\n      }\n    })\n  },\n  { immediate: true },\n)\n\nconst filteredTags = computed(() => {\n  if (!filter.value) return sortedOptions.value\n\n  return sortedOptions.value.filter((tag) =>\n    tag.toLowerCase().includes(filter.value.toLowerCase()),\n  )\n})\n\nconst removeTag = (tag: string) => {\n  const newValue = currentValue.value.filter((item: string) => item !== tag)\n  ignoreUpdates(() => {\n    props.context.node.input(newValue)\n  })\n}\n\nconst toggleTag = (tag: string) => {\n  const normalizedValue = [...currentValue.value]\n  if (normalizedValue.includes(tag)) {\n    removeTag(tag)\n    return\n  }\n  normalizedValue.push(tag)\n  ignoreUpdates(() => {\n    props.context.node.input(normalizedValue)\n  })\n}\n\nconst { notify } = useNotifications()\n\nconst createTag = () => {\n  const tag = filter.value\n  if (!tag) return\n  if (tagExists(tag)) {\n    notify({\n      id: 'tag-exists',\n      type: NotificationTypes.Warn,\n      message: __('Tag \"%s\" already exists.'),\n      messagePlaceholder: [tag],\n    })\n    return\n  }\n\n  toggleTag(tag)\n  newTags.value.push({\n    value: tag,\n    label: tag,\n  })\n  filter.value = ''\n  filterInput.value?.focus() // keep focus inside input, if clicked\n}\n\nuseTraverseOptions(tagsListbox, { direction: 'vertical' })\n\nconst processSearchKeydown = (event: KeyboardEvent) => {\n  const { key } = event\n  if (key === ',') stopEvent(event) // never allow comma in input\n  if (!filter.value) return\n  if (['Enter', 'Tab', ','].includes(key)) {\n    stopEvent(event)\n\n    if (props.context.canCreate) createTag()\n  }\n}\n</script>\n\n<template>\n  <CommonDialog :label=\"__('Tags')\" :name=\"name\">\n    <div class=\"w-full border-b border-white/10 p-4\">\n      <CommonInputSearch\n        ref=\"filterInput\"\n        v-model=\"filter\"\n        placeholder=\"Tag name…\"\n        @keydown=\"processSearchKeydown\"\n      >\n        <template v-if=\"context.canCreate\" #controls>\n          <button\n            v-if=\"filter.length > 0\"\n            :aria-label=\"$t('Create tag')\"\n            class=\"bg-green rounded-3xl text-white\"\n            :class=\"{\n              'bg-green/40 text-white/20': tagExists(filter),\n            }\"\n            type=\"button\"\n            :disabled=\"tagExists(filter)\"\n            @click=\"createTag()\"\n          >\n            <CommonIcon class=\"p-1\" size=\"tiny\" name=\"add\" decorative />\n          </button>\n        </template>\n      </CommonInputSearch>\n    </div>\n    <div\n      ref=\"tagsListbox\"\n      class=\"flex w-full flex-col\"\n      :aria-label=\"$t('Select…')\"\n      role=\"listbox\"\n      aria-multiselectable=\"true\"\n    >\n      <button\n        v-for=\"option of filteredTags\"\n        :id=\"`${name}-${option}`\"\n        :key=\"option\"\n        class=\"focus:bg-blue-highlight flex w-full items-center px-4 focus:outline-hidden\"\n        role=\"option\"\n        aria-setsize=\"-1\"\n        :aria-posinset=\"sortedOptions.indexOf(option) + 1\"\n        :aria-selected=\"isCurrentValue(option)\"\n        @click=\"toggleTag(option)\"\n        @keydown.space.prevent=\"toggleTag(option)\"\n      >\n        <CommonIcon\n          :class=\"{\n            '!text-white': isCurrentValue(option),\n          }\"\n          :name=\"isCurrentValue(option) ? 'check-box-yes' : 'check-box-no'\"\n          class=\"text-white/50 ltr:mr-3 rtl:ml-3\"\n          size=\"base\"\n          decorative\n        />\n\n        <span class=\"flex-1 py-3 text-left\">\n          {{ option }}\n        </span>\n      </button>\n    </div>\n  </CommonDialog>\n</template>\n"],"names":["props","__props","localValue","useValue","toRef","currentValue","computed","isCurrentValue","tag","filter","ref","newTags","tagsQuery","QueryHandler","useAutocompleteSearchTagQuery","autocompleteTags","_a","filterInput","tagsListbox","sortedOptions","sorting","allOptions","a","b","a1","b1","tagExists","option","ignoreUpdates","watchIgnorable","newValue","filteredTags","removeTag","item","toggleTag","normalizedValue","notify","useNotifications","createTag","NotificationTypes","useTraverseOptions","processSearchKeydown","event","key","stopEvent"],"mappings":"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"}