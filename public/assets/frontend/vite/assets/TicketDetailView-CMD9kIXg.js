const __vite__mapDeps=(i,m=__vite__mapDeps,d=(m.f||(m.f=["assets/ArticleReplyDialog-Cch5JWgX.js","assets/vue-oicRkvo0.js","assets/vendor-C11O1Xx8.js","assets/commonjsHelpers-BosuxZz1.js","assets/overviewAttributes.api-C09LSZ8O.js","assets/routes-CgLO9M4y.js","assets/vite-FJshFMF2.js","assets/apollo-Cj5TVUDk.js","assets/lodash-pFOI14f-.js","assets/formkit-5nol1GBe.js","assets/overviewAttributes-r_4zXopK.css","assets/mobile-Bk4bKGxF.js","assets/pwa-THoW_3xc.js","assets/add.api-CxwFhgGn.js","assets/datepicker-BBNcWeHz.js","assets/date-B2UyDZN7.js","assets/mobile-Crnk7LCD.css","assets/CommonDialog.vue_vue_type_script_setup_true_lang-CID2Z6MI.js"])))=>i.map(i=>d[i]);
import{f as se,a1 as J,m as p,D as S,y as U,p as x,I as T,q as g,M as N,E as w,u as s,T as X,L as Z,Q as Le,r as $,c as k,ar as le,aV as ce,aN as ue,ao as Ee,w as Ce,b6 as ee,t as Me,d as te,ap as Ne,b7 as Be,H as ae,G as re,J as Ve,n as Oe,$ as Ge}from"./vue-oicRkvo0.js";import{u as ze,e as de,M as oe,Q as He,N as ie,U as je,c as Qe}from"./apollo-Cj5TVUDk.js";import{_ as qe}from"./Form.vue_vue_type_script_setup_true_lang-B6L-6HzY.js";import{u as Pe}from"./useForm-CUKec4n5.js";import{X as pe,ba as ne,Z as Ke,a2 as We}from"./overviewAttributes.api-C09LSZ8O.js";import{u as Ye}from"./useOnlineNotificationSeen-MT6qWa0p.js";import{b as Je,c as Xe,a as Ze}from"./useTicketLiveUserList-fkbxnu3k.js";import{u as et}from"./useTicketView-CMOCBKg-.js";import{T as tt,a as at}from"./ticketUpdates.api-BhGIG_Ti.js";import{u as rt}from"./useErrorHandler-ZIzy1Mvt.js";import{j as B,r as ot,a8 as it}from"./routes-CgLO9M4y.js";import{_ as nt}from"./CommonLoader.vue_vue_type_script_setup_true_lang-BtrvaoyW.js";import{j as st,m as lt,n as ct}from"./mobile-Bk4bKGxF.js";import{n as V}from"./vendor-C11O1Xx8.js";import{T as ut}from"./ticketAttributes.api-rqx5ITab.js";import{_ as dt}from"./vite-FJshFMF2.js";import{T as pt}from"./useTicketInformation-DhcXzEKN.js";import{n as mt,a as ft}from"./lodash-pFOI14f-.js";import"./formkit-5nol1GBe.js";import"./FormGroup.vue_vue_type_script_setup_true_lang-DIx-HUKU.js";import"./seen.api-DLK-LLmy.js";import"./utils-C-eON4SW.js";import"./useObjectAttributeFormData-BTXeBYyl.js";import"./index-D5f5eTVX.js";import"./useBaseUrl-BsZiEKQE.js";import"./useCopyToClipboard-CjkPg__g.js";import"./useTicketSignature-LslYi6X7.js";import"./openExternalLink-B2ZtqYBi.js";import"./getAttachmentLinks-Dz1qdLDp.js";import"./pwa-THoW_3xc.js";import"./add.api-CxwFhgGn.js";import"./datepicker-BBNcWeHz.js";import"./date-B2UyDZN7.js";import"./commonjsHelpers-BosuxZz1.js";const vt=V`
    query ticketWithMentionLimit($ticketId: ID, $ticketInternalId: Int, $ticketNumber: String, $mentionsCount: Int = null) {
  ticket(
    ticket: {ticketId: $ticketId, ticketInternalId: $ticketInternalId, ticketNumber: $ticketNumber}
  ) {
    ...ticketAttributes
    createArticleType {
      id
      name
    }
    mentions(first: $mentionsCount) {
      totalCount
      edges {
        node {
          ...ticketMention
        }
        cursor
      }
    }
  }
}
    ${ut}
${tt}`;function kt(n={},l={}){return ze(vt,n,l)}const yt={key:0,class:"pb-safe-1 fixed bottom-0 z-10 bg-gray-600/90 px-2 text-white backdrop-blur-lg transition ltr:right-0 ltr:left-0 rtl:right-0 rtl:left-0"},bt={class:"relative flex flex-1 items-center gap-2 p-2"},wt={class:"flex-1"},ht=["aria-label"],Tt={key:0,"aria-hidden":"true",class:"bg-yellow absolute top-0 z-10 h-4 min-w-[1rem] rounded-full px-1 text-center text-xs text-black ltr:ml-4 rtl:mr-4"},gt={class:"flex gap-2"},Dt={class:"line-clamp-1 break-all"},It=["aria-label"],_t=se({__name:"TicketDetailViewActions",props:{formInvalid:{type:Boolean},newRepliesCount:{},newArticlePresent:{type:Boolean},canReply:{type:Boolean},canSave:{type:Boolean},canScrollDown:{type:Boolean},hidden:{type:Boolean}},emits:["reply","save"],setup(n,{emit:l}){const m=l,u={enter:300,leave:200},c="smooth",y=()=>{window.scrollTo({top:document.body.scrollHeight,behavior:c})};return(e,a)=>{const r=J("CommonIcon"),o=J("FormKit");return p(),S(X,{duration:s(u),"enter-from-class":"translate-y-full","enter-active-class":"translate-y-0","enter-to-class":"-translate-y-1/3","leave-from-class":"-translate-y-1/3","leave-active-class":"translate-y-full","leave-to-class":"translate-y-full"},{default:U(()=>[e.hidden?w("",!0):(p(),x("div",yt,[T("div",bt,[T("div",wt,[g(X,{duration:s(u),"enter-from-class":"rtl:translate-x-20 ltr:-translate-x-20","enter-to-class":"rtl:-translate-x-0 ltr:translate-x-0","leave-from-class":"rtl:-translate-x-0 ltr:translate-x-0","leave-to-class":"rtl:translate-x-20 ltr:-translate-x-20"},{default:U(()=>[e.canScrollDown?(p(),x("button",{key:0,class:"bg-blue relative flex h-8 cursor-pointer items-center rounded-2xl px-2 transition","aria-label":e.newRepliesCount?e.$t("Scroll down to see %s new replies",e.newRepliesCount):e.$t("Scroll down"),onClick:y},[g(r,{name:"arrow-down",size:"small",decorative:""}),e.newRepliesCount?(p(),x("span",Tt,N(e.newRepliesCount),1)):w("",!0)],8,ht)):w("",!0)]),_:1},8,["duration"])]),T("div",gt,[e.canReply?(p(),S(o,{key:0,variant:"secondary","input-class":"flex gap-1 flex justify-center items-center font-semibold text-base px-3 py-1 !text-white formkit-variant-secondary:bg-blue rounded select-none",type:"button",onClick:a[0]||(a[0]=Z(d=>m("reply"),["prevent"]))},{default:U(()=>[T("div",null,[g(r,{name:"chat",size:"small",decorative:""})]),T("span",Dt,N(e.newArticlePresent?e.$t("Edit reply"):e.$t("Add reply")),1)]),_:1})):w("",!0),e.canSave?(p(),S(o,{key:1,variant:"submit","input-class":"font-semibold text-base px-4 py-1 !text-black formkit-variant-primary:bg-yellow rounded select-none","wrapper-class":"flex justify-center items-center",type:"button",form:"form-ticket-edit",onClick:a[1]||(a[1]=Z(d=>m("save"),["prevent"]))},{default:U(()=>[Le(N(e.$t("Save")),1)]),_:1})):w("",!0),e.formInvalid?(p(),x("button",{key:2,onClick:a[2]||(a[2]=d=>m("save"))},[T("span",{role:"status","aria-label":e.$t("Validation failed"),class:"bg-red absolute bottom-7 h-5 w-5 cursor-pointer rounded-full text-center text-xs leading-5 text-black ltr:right-2 rtl:left-2"},[g(r,{class:"mx-auto h-5",name:"close",size:"tiny",decorative:""})],8,It)])):w("",!0)])])]))]),_:1},8,["duration"])}}}),$t=(n,l,m)=>{const u=$(!1),c=$(!1),y=k(()=>{var i;if(!(!c.value&&!u.value))return(i=l.value)==null?void 0:i.getNodeByName("article")}),e=k(()=>{var i,f;return!!((f=(i=y.value)==null?void 0:i.context)!=null&&f.state.valid)}),a=st({name:"ticket-article-reply",component:()=>dt(()=>import("./ArticleReplyDialog-Cch5JWgX.js"),__vite__mapDeps([0,1,2,3,4,5,6,7,8,9,10,11,12,13,14,15,16,17])),beforeOpen:()=>{u.value=!0},afterClose:()=>{u.value=!1}}),r=()=>{c.value=!0},o=le(),d=()=>{var D,L;const i=(D=l.value)==null?void 0:D.getNodeByName("state_id"),f=(L=l.value)==null?void 0:L.getNodeByName("isDefaultFollowUpStateSet");return!i||!f||!f.value?!1:(i.reset(),f.reset(),!0)};return{articleReplyDialog:a,newTicketArticleRequested:u,newTicketArticlePresent:c,articleFormGroupNode:y,isArticleFormGroupValid:e,openArticleReplyDialog:async({updateFormLocation:i})=>{if(n.value)return a.open({name:a.name,ticket:n,form:l,needSpaceForSaveBanner:m,newTicketArticlePresent:c,articleFormGroupNode:y,updateFormLocation:i,onDone(){r()},onDiscard(){c.value=!1,d()},onShowArticleForm(){i("[data-ticket-article-reply-form]")},onHideArticleForm(){if(o.name==="TicketInformationDetails"){i("[data-ticket-edit-form]");return}i("body")}})},closeArticleReplyDialog:(i=!1)=>(i&&r(),a.close())}},St=V`
    mutation ticketLiveUserDelete($id: ID!, $app: EnumTaskbarApp!) {
  ticketLiveUserDelete(id: $id, app: $app) {
    success
    errors {
      ...errors
    }
  }
}
    ${pe}`;function At(n={}){return de(St,n)}const Rt=V`
    mutation ticketLiveUserUpsert($id: ID!, $app: EnumTaskbarApp!, $editing: Boolean!) {
  ticketLiveUserUpsert(id: $id, app: $app, editing: $editing) {
    success
    errors {
      ...errors
    }
  }
}
    ${pe}`;function Ft(n={}){return de(Rt,n)}const Ut=(n,l,m)=>{const{liveUserList:u}=Je(n,l,B.Mobile),c=new oe(Ft()),y=new oe(At()),e=async(r,o=!1)=>{await c.send({id:ne("Ticket",r),editing:o,app:B.Mobile}).catch(ee)},a=async r=>{await y.send({id:ne("Ticket",r),app:B.Mobile}).catch(ee)};return ce(async(r,o)=>{const d=r.params.internalId,b=o.params.internalId;d!==b&&(u.value=[],a(b),e(d))}),ue(async(r,o)=>{const d=o.params.internalId;a(d)}),Ee(async()=>{await e(n.value)}),Ce(m,async r=>{await e(n.value,r)}),{liveUserList:u}},xt=5,fa=se({__name:"TicketDetailView",props:{internalId:{}},setup(n){const l=n,m=k(()=>Ke("Ticket",l.internalId)),{createQueryErrorHandler:u}=rt(),c=new He(kt(()=>({ticketId:m.value,mentionsCount:xt})),{errorCallback:u({notFound:__("Ticket with specified ID was not found. Try checking the URL for errors."),forbidden:__("You have insufficient rights to view this ticket.")})}),y=c.result(),e=k(()=>{var t;return(t=y.value)==null?void 0:t.ticket});c.subscribeToMore(()=>({document:at,variables:{ticketId:m.value},onError:mt}));const a=$("body"),r=k(()=>a.value!=="body"),{form:o,canSubmit:d,isDirty:b,formSubmit:O,formReset:i}=Pe(),{initialTicketValue:f,isTicketFormGroupValid:D,editTicket:L}=Xe(e,o),{currentArticleType:E,ticketSchema:me,articleSchema:fe,securityIntegration:ve,isTicketEditable:I,articleTypeHandler:ke,articleTypeSelectHandler:ye}=Ze(e,o),be=k(()=>I.value&&b.value),{articleReplyDialog:A,newTicketArticleRequested:G,newTicketArticlePresent:_,isArticleFormGroupValid:z,openArticleReplyDialog:we,closeArticleReplyDialog:H}=$t(e,o,be),he=[{isLayout:!0,component:"FormGroup",props:{style:{if:'$formLocation !== "[data-ticket-edit-form]"',then:"display: none;"},showDirtyMark:!0},children:[me]},{isLayout:!0,component:"FormGroup",props:{style:{if:'$formLocation !== "[data-ticket-article-reply-form]"',then:"display: none;"}},children:[fe]}],{isTicketAgent:Te}=et(e),{notify:j}=Qe(),ge=async t=>{var R,F;let v=ft(t);(R=E.value)!=null&&R.updateForm&&(v=E.value.updateForm(t));try{const h=await L(v,{skipValidators:Object.values(it)});if((F=h==null?void 0:h.ticketUpdate)!=null&&F.ticket)return j({id:"ticket-update",type:ie.Success,message:__("Ticket updated successfully.")}),_.value=!1,{reset:(Lt,xe)=>{Oe(()=>{H().then(()=>{i({values:{ticket:xe.ticket}})})})}}}catch(h){h instanceof je&&j({id:"ticket-update-error",message:h.generalErrors[0],type:ie.Error})}},Q=t=>{a.value=t},De=k(()=>_.value?D.value&&z.value:D.value),C=()=>we({updateFormLocation:Q}),{liveUserList:Ie}=Ut(Me(()=>l.internalId),Te,b),q=$(!1),_e=t=>{q.value=t},P=$(!1),M=$(!1);ce((t,v)=>{t.params.internalId!==v.params.internalId&&(P.value=!1),M.value=!1});const K=te(new Set);Ge(pt,{ticketQuery:c,initialFormTicketValue:f,ticket:e,form:o,scrolledToBottom:P,newTicketArticleRequested:G,newTicketArticlePresent:_,updateFormLocation:Q,isTicketEditable:I,showArticleReplyDialog:C,liveUserList:Ie,refetchingStatus:q,newArticlesIds:K,scrollDownState:M,updateRefetchingStatus:_e}),Ye(e),ue(async()=>{if(!b.value)return!0;const{waitForConfirmation:t}=We();return await t(__("Are you sure? You have unsaved changes that will get lost."),{buttonLabel:__("Discard changes"),buttonVariant:"danger"})});const $e=Ne(),Se=le(),Ae=()=>{var t;!D.value&&Se.name!=="Edit"?(A.isOpened.value&&H(!0),$e.push(`/tickets/${(t=e.value)==null?void 0:t.internalId}/information`)):_.value&&!z.value&&!A.isOpened.value&&C(),O()},Re=te({formLocation:a,securityIntegration:ve,newTicketArticleRequested:G,newTicketArticlePresent:_,currentArticleType:E}),{isOpened:Fe}=lt(),W=k(()=>A.isOpened.value?!1:I.value),Y=k(()=>A.isOpened.value?!1:M.value),Ue=k(()=>{const t=ct();return Fe.value||t.size>1||t.size===1&&!A.isOpened.value?!1:I.value&&b.value||W.value||Y.value});return(t,v)=>{var R;return p(),x(Ve,null,[g(s(Be)),v[1]||(v[1]=T("div",{class:"pb-safe-16"},null,-1)),s(I)?(p(),S(re,{key:0,to:a.value},[g(nt,{class:ae(r.value?"visible":"hidden"),loading:!e.value},{default:U(()=>{var F;return[(F=e.value)!=null&&F.id&&s(f)?(p(),S(qe,{id:"form-ticket-edit",key:e.value.id,ref_key:"form",ref:o,schema:he,"flatten-form-groups":["ticket"],handlers:[s(ke)()],"form-kit-plugins":[s(ye)],"schema-data":Re,"initial-values":s(f),"initial-entity-object":e.value,"form-updater-id":s(ot).FormUpdaterUpdaterTicketEdit,"use-object-attributes":"","aria-hidden":!r.value,class:ae(r.value?"visible":"hidden"),onSubmit:v[0]||(v[0]=h=>ge(h))},null,8,["handlers","form-kit-plugins","schema-data","initial-values","initial-entity-object","form-updater-id","aria-hidden","class"])):w("",!0)]}),_:1},8,["class","loading"])],8,["to"])):w("",!0),(R=s(o))!=null&&R.formNode?(p(),S(re,{key:1,to:"body"},[g(_t,{"form-invalid":s(d)&&!De.value,"new-replies-count":K.size,"new-article-present":s(_),"can-reply":W.value,"can-save":s(I)&&s(b),"can-scroll-down":Y.value,hidden:!Ue.value,onReply:C,onSave:Ae},null,8,["form-invalid","new-replies-count","new-article-present","can-reply","can-save","can-scroll-down","hidden"])])):w("",!0)],64)}}});export{fa as default};
//# sourceMappingURL=TicketDetailView-CMD9kIXg.js.map
