import{f as E,a1 as F,m as t,p as w,I as N,q as _,y as r,Q as c,M as l,J as D,x as X,D as f,u as e,c as P,r as L,k as le,E as d,ar as Y,ap as ce,d as Q}from"./vue-oicRkvo0.js";import{a4 as j,X as ue,aq as q}from"./overviewAttributes.api-C09LSZ8O.js";import{_ as O}from"./Form.vue_vue_type_script_setup_true_lang-B6L-6HzY.js";import{u as Z}from"./useForm-CUKec4n5.js";import{u as me,a as de}from"./twoFactorMethodInitiateAuthentication.api-DmImhgjQ.js";import{F as fe,e as pe,R as ge,T as ye}from"./routes-CgLO9M4y.js";import{U as z,M as K,e as ve}from"./apollo-Cj5TVUDk.js";import{c as T,d as _e,h as he}from"./desktop-l0eJ1dZN.js";import{_ as be}from"./CommonPublicLinks.vue_vue_type_script_setup_true_lang-DcbvsgxJ.js";import{_ as we}from"./LayoutPublicPage.vue_vue_type_script_setup_true_lang-C_6Ob6yy.js";import{_ as ke}from"./CommonThirdPartyAuthenticationButton.vue_vue_type_script_setup_true_lang-Cn_DdVLy.js";import{n as $e}from"./vendor-C11O1Xx8.js";import"./lodash-pFOI14f-.js";import"./formkit-5nol1GBe.js";import"./vite-FJshFMF2.js";import"./FormGroup.vue_vue_type_script_setup_true_lang-DIx-HUKU.js";import"./useCopyToClipboard-CjkPg__g.js";import"./theme-Bv2ClBzZ.js";import"./datepicker-BBNcWeHz.js";import"./date-B2UyDZN7.js";import"./autocompleteTags.api-CG5-cm_A.js";import"./autocompleteSearchTicket.api-DfOQWGlO.js";import"./ticketUpdates.api-BhGIG_Ti.js";import"./ticketAttributes.api-rqx5ITab.js";import"./useTicketCreateArticleType-D7iVcJ_6.js";import"./types-Cu-Nkl7K.js";import"./useTicketCreateView-HCH46SPv.js";import"./commonjsHelpers-BosuxZz1.js";import"./usePublicLinks-CDMBq4UM.js";import"./CommonLogo.vue_vue_type_script_setup_true_lang-xQq9wMEL.js";import"./useLogoUrl-8sIhej5J.js";import"./LayoutPublicPageBoxActions-BFjF_v1c.js";const Ce={class:"mt-2.5 w-full"},Me={class:"mb-2.5 flex justify-center"},Ae={class:"flex flex-wrap gap-2"},Le=E({__name:"LoginThirdParty",props:{providers:{}},setup(k){const C=k,{fingerprint:u}=fe();return(n,s)=>{const h=F("CommonLabel");return t(),w("section",Ce,[N("div",Me,[_(h,null,{default:r(()=>[c(l(n.$c.user_show_password_login?n.$t("Or sign in using"):n.$t("Sign in using")),1)]),_:1})]),N("div",Ae,[(t(!0),w(D,null,X(C.providers,p=>(t(),f(ke,{key:p.name,class:"grow basis-[calc(50%-theme(spacing.2))]",url:`${p.url}?fingerprint=${e(u)}`,"button-prefix-icon":p.icon,"button-size":"large","button-block":"","button-variant":"primary","button-label":p.name},{default:r(()=>[c(l(n.$t(p.label)),1)]),_:2},1032,["url","button-prefix-icon","button-label"]))),128))])])}}}),Fe=E({__name:"LoginRecoveryCode",props:{credentials:{}},emits:["finish","error","clear-error"],setup(k,{emit:C}){const u=k,n=C,s=[{type:"text",name:"code",label:__("Recovery Code"),required:!0,props:{help:__("Enter one of your unused recovery codes.")}}],h=j(),{form:p,isDisabled:o}=Z(),g=M=>{n("clear-error");const{login:i,password:A,rememberMe:b}=u.credentials;return h.login({login:i,password:A,rememberMe:b,recoveryCode:M.code}).then(()=>{n("finish")}).catch($=>{$ instanceof z&&n("error",$)})};return(M,i)=>(t(),f(O,{ref_key:"form",ref:p,schema:s,onSubmit:i[0]||(i[0]=A=>g(A))},{"after-fields":r(()=>[_(T,{type:"submit",variant:"submit",size:"large",class:"mt-8",block:"",disabled:e(o)},{default:r(()=>[c(l(M.$t("Sign in")),1)]),_:1},8,["disabled"])]),_:1},512))}}),Te={key:1,class:"flex flex-col items-center justify-center"},Se=E({__name:"LoginTwoFactor",props:{credentials:{},twoFactor:{}},emits:["finish","error","clear-error"],setup(k,{emit:C}){const u=k,n=C,s=P(()=>u.twoFactor.loginOptions),h=[{type:"text",name:"code",label:__("Security Code"),required:!0,props:{help:P(()=>s.value.helpMessage),autocomplete:"one-time-code",autofocus:!0,inputmode:"numeric",pattern:"[0-9]*"}}],p=j(),o=L(!1),g=L(null),M=L(!0),i=b=>{n("clear-error");const{login:$,password:y,rememberMe:v}=u.credentials;return p.login({login:$,password:y,rememberMe:v,twoFactorAuthentication:{payload:b,method:u.twoFactor.name}}).then(()=>{M.value=!1,n("finish")}).catch(x=>{x instanceof z&&n("error",x)})},A=async()=>{var $;if(!s.value.setup)return;const b=new K(me());n("clear-error"),g.value=null,o.value=!0;try{const y=await b.send({twoFactorMethod:u.twoFactor.name,password:u.credentials.password,login:u.credentials.login});if(!(($=y==null?void 0:y.twoFactorMethodInitiateAuthentication)!=null&&$.initiationData)){g.value=__("Two-factor authentication method could not be initiated.");return}const v=await s.value.setup(y.twoFactorMethodInitiateAuthentication.initiationData);M.value=v.retry??!0,v!=null&&v.success?await i(v.payload):v!=null&&v.error&&(g.value=v.error)}catch(y){y instanceof z&&(g.value=y.errors[0].message)}finally{o.value=!1}};return le(async()=>{await A()}),(b,$)=>{const y=F("CommonLabel");return s.value.form!==!1?(t(),f(O,{key:0,schema:h,onSubmit:$[0]||($[0]=v=>i(v.code))},{"after-fields":r(()=>[_(T,{type:"submit",variant:"submit",size:"large",class:"mt-8",block:"",disabled:o.value},{default:r(()=>[c(l(b.$t("Sign in")),1)]),_:1},8,["disabled"])]),_:1})):s.value.setup?(t(),w("section",Te,[g.value&&s.value.errorHelpMessage?(t(),f(y,{key:0,class:"mt-5"},{default:r(()=>[c(l(b.$t(s.value.errorHelpMessage)),1)]),_:1})):s.value.helpMessage?(t(),f(y,{key:1,class:"mt-5"},{default:r(()=>[c(l(b.$t(s.value.helpMessage)),1)]),_:1})):d("",!0),_(_e,{class:"mt-8 mb-3",loading:o.value,error:g.value},null,8,["loading","error"]),!o.value&&M.value?(t(),f(T,{key:2,size:"large",variant:"primary",class:"mt-5",block:"",onClick:A},{default:r(()=>[c(l(b.$t("Retry")),1)]),_:1})):d("",!0)])):d("",!0)}}}),Pe={key:0,class:"mt-2.5 text-center"},Ee={class:"mt-8 text-center text-sm"},xe=E({__name:"LoginTwoFactorMethods",props:{methods:{},defaultMethod:{},recoveryCodesAvailable:{type:Boolean}},emits:["select","cancel","use-recovery-code"],setup(k,{emit:C}){const u=C;return(n,s)=>{const h=F("CommonLabel"),p=F("CommonLink");return t(),w(D,null,[(t(!0),w(D,null,X(n.methods,o=>(t(),w("section",{key:o.name,class:"mt-3 flex flex-col"},[_(T,{size:"large",block:"","prefix-icon":o.icon,variant:o.name==n.defaultMethod?"primary":"tertiary",onClick:g=>u("select",o.name)},{default:r(()=>[c(l(n.$t(o.label)),1)]),_:2},1032,["prefix-icon","variant","onClick"]),o.description?(t(),w("div",Pe,[_(h,null,{default:r(()=>[c(l(n.$t(o.description)),1)]),_:2},1024)])):d("",!0)]))),128)),N("div",Ee,[n.recoveryCodesAvailable?(t(),f(p,{key:0,link:"#",onClick:s[0]||(s[0]=o=>u("use-recovery-code"))},{default:r(()=>[c(l(n.$t("Or use one of your recovery codes.")),1)]),_:1})):d("",!0)]),_(T,{class:"mt-5",size:"large",block:"",onClick:s[1]||(s[1]=o=>u("cancel"))},{default:r(()=>[c(l(n.$t("Cancel & Go Back")),1)]),_:1})],64)}}}),Ve=$e`
    mutation adminPasswordAuthVerify($token: String!) {
  adminPasswordAuthVerify(token: $token) {
    login
    errors {
      ...errors
    }
  }
}
    ${ue}`;function Re(k={}){return ve(Ve,k)}const qe=k=>{const u=Y().query.token;if(!u)return{};const n=new K(Re({variables:{token:u}}),{errorShowNotification:!1}),s=L(!1),h=L("");n.send().then(o=>{var g;(g=o==null?void 0:o.adminPasswordAuthVerify)!=null&&g.login&&(k.formChangeFields.login={props:{disabled:!0}},k.formInitialValues.login=o.adminPasswordAuthVerify.login,h.value=__("The token is valid. You are now able to login via password once."),s.value=!0)}).catch(()=>{h.value=__("The token for the admin password login is invalid.")});const p=P(()=>s.value?"success":"danger");return{verifyTokenResult:s,verifyTokenMessage:h,verifyTokenAlertVariant:p}},De={key:0,class:"mb-1 rounded-lg bg-red-500 px-4 py-2 text-sm text-white"},ze=["innerHTML"],Be={key:0,class:"flex justify-center py-3"},Ie={key:5,class:"mt-3 text-center"},He={key:0,class:"inline-flex flex-wrap items-center justify-center p-2 text-sm"},bt=E({__name:"Login",setup(k){const C=pe(),u=ce(),n=Y(),s=j(),{enabledProviders:h,hasEnabledProviders:p}=ge(),o=L(""),g=a=>{o.value=a.generalErrors[0]},M=()=>{o.value=""},{loginFlow:i,askTwoFactor:A,twoFactorPlugin:b,twoFactorAllowedMethods:$,updateState:y,updateSecondFactor:v,hasAlternativeLoginMethod:x,loginPageTitle:W,cancelAndGoBack:ee}=de(M),B=()=>{const{redirect:a}=n.query;typeof a=="string"?u.replace(a):u.replace("/")},te=async a=>{try{const{twoFactor:m,afterAuth:S}=await s.login(a);if(S){he(u,S);return}if(m!=null&&m.defaultTwoFactorAuthenticationMethod){A(m,a);return}B()}catch(m){o.value=m instanceof z?m.generalErrors[0]:String(m)}},oe=[{name:"login",type:"text",label:__("Username / Email"),required:!0},{name:"password",label:__("Password"),type:"password",required:!0},{isLayout:!0,element:"div",attrs:{class:"flex grow items-center justify-between"},children:[{type:"checkbox",name:"rememberMe",label:__("Remember me"),value:!1},{if:"$userLostPassword === true",isLayout:!0,component:"CommonLink",props:{class:"text-right text-sm",link:"/reset-password"},children:__("Forgot password?")}]}],re=P(()=>C.config.user_lost_password),ne=Q({userLostPassword:re}),{form:ae,isDisabled:se}=Z(),U={},G=Q({}),{verifyTokenResult:I,verifyTokenMessage:J,verifyTokenAlertVariant:ie}=qe({formChangeFields:G,formInitialValues:U}),H=P(()=>C.config.user_show_password_login||!p.value||(I==null?void 0:I.value));return(a,m)=>{const S=F("CommonAlert"),V=F("CommonLabel");return t(),f(we,{"box-size":"small",title:e(W),"show-logo":""},{bottomContent:r(()=>[H.value?d("",!0):(t(),w("div",He,[_(V,{class:"text-center text-stone-200 dark:text-neutral-500"},{default:r(()=>[c(l(a.$t("If you have problems with the third-party login you can request a one-time password login as an admin.")),1)]),_:1}),_(q,{link:"/admin-password-auth"},{default:r(()=>[c(l(a.$t("Request the password login here.")),1)]),_:1})])),e(i).state==="2fa-select"?(t(),f(V,{key:1,class:"mt-3 mb-3 text-stone-200 dark:text-neutral-500"},{default:r(()=>[c(l(a.$t("Contact the administrator if you have any problems logging in.")),1)]),_:1})):d("",!0),e(i).state==="credentials"?(t(),f(q,{key:2,class:"mt-3 text-sm",link:"/mobile",external:""},{default:r(()=>[c(l(a.$t("Continue to mobile")),1)]),_:1})):d("",!0),_(be,{screen:e(ye).Login},null,8,["screen"])]),default:r(()=>[a.$c.maintenance_mode?(t(),w("div",De,l(a.$t("Zammad is currently in maintenance mode. Only administrators can log in. Please wait until the maintenance window is over.")),1)):d("",!0),a.$c.maintenance_login&&a.$c.maintenance_login_message?(t(),w("div",{key:1,class:"mb-1 rounded-lg bg-green-500 px-4 py-2 text-sm text-white",innerHTML:a.$c.maintenance_login_message},null,8,ze)):d("",!0),e(J)?(t(),f(S,{key:2,variant:e(ie)},{default:r(()=>[c(l(a.$t(e(J))),1)]),_:1},8,["variant"])):d("",!0),H.value?(t(),w(D,{key:3},[o.value?(t(),f(S,{key:0,variant:"danger"},{default:r(()=>[c(l(a.$t(o.value)),1)]),_:1})):d("",!0),e(i).state==="credentials"&&H.value?(t(),f(O,{key:1,id:"login",ref_key:"form",ref:ae,"form-class":"mb-2.5 space-y-2.5",schema:oe,"schema-data":ne,"initial-values":U,"change-fields":G,onSubmit:m[0]||(m[0]=R=>te(R))},{"after-fields":r(()=>[a.$c.user_create_account?(t(),w("div",Be,[_(V,null,{default:r(()=>[c(l(a.$t("New user?"))+" ",1),_(q,{link:"/signup",class:"select-none",size:"medium"},{default:r(()=>[c(l(a.$t("Register")),1)]),_:1})]),_:1})])):d("",!0),_(T,{type:"submit",variant:"submit",size:"large",block:"",disabled:e(se)},{default:r(()=>[c(l(a.$t("Sign in")),1)]),_:1},8,["disabled"])]),_:1},8,["schema-data","change-fields"])):e(i).state==="2fa"&&e(b)&&e(i).credentials?(t(),f(Se,{key:2,credentials:e(i).credentials,"two-factor":e(b),onError:g,onClearError:M,onFinish:B},null,8,["credentials","two-factor"])):e(i).state==="recovery-code"&&e(i).credentials?(t(),f(Fe,{key:3,credentials:e(i).credentials,onError:g,onClearError:M,onFinish:B},null,8,["credentials"])):e(i).state==="2fa-select"?(t(),f(xe,{key:4,methods:e($),"default-method":e(i).defaultMethod,"recovery-codes-available":e(i).recoveryCodesAvailable,onSelect:e(v),onUseRecoveryCode:m[1]||(m[1]=R=>e(y)("recovery-code")),onCancel:m[2]||(m[2]=R=>e(ee)())},null,8,["methods","default-method","recovery-codes-available","onSelect"])):d("",!0),(e(i).state==="2fa"||e(i).state==="recovery-code")&&e(x)?(t(),w("section",Ie,[_(V,null,{default:r(()=>[c(l(a.$t("Having problems?"))+" ",1),_(q,{link:"#",class:"select-none",onClick:m[3]||(m[3]=R=>e(y)("2fa-select"))},{default:r(()=>[c(l(a.$t("Try another method")),1)]),_:1})]),_:1})])):d("",!0)],64)):d("",!0),e(p)&&e(i).state==="credentials"?(t(),f(Le,{key:4,providers:e(h)},null,8,["providers"])):d("",!0)]),_:1},8,["title"])}}});export{bt as default};
//# sourceMappingURL=Login-BSDX7WFx.js.map
