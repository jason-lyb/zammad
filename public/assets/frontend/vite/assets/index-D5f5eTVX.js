import{X as A,a2 as H,aJ as v,aL as T,aR as Q,b5 as G,b6 as J,aF as K,ay as C}from"./overviewAttributes.api-C09LSZ8O.js";import{n as I}from"./vendor-C11O1Xx8.js";import{e as $,M as D}from"./apollo-Cj5TVUDk.js";import{a as M,i as _,a7 as f,a9 as X,e as P}from"./routes-CgLO9M4y.js";import{u as Y}from"./useBaseUrl-BsZiEKQE.js";import{u as Z}from"./useCopyToClipboard-CjkPg__g.js";import{x as ee,y as S,o as te,g as ne,k as oe}from"./lodash-pFOI14f-.js";import{c as k,R as ae,r as ie}from"./vue-oicRkvo0.js";import{g as V}from"./useTicketSignature-LslYi6X7.js";import{o as F}from"./openExternalLink-B2ZtqYBi.js";import{g as re}from"./getAttachmentLinks-Dz1qdLDp.js";import{O as se,a as le}from"./formkit-5nol1GBe.js";import{g as B}from"./useTicketView-CMOCBKg-.js";const ce=I`
    mutation ticketArticleDelete($articleId: ID!) {
  ticketArticleDelete(articleId: $articleId) {
    success
    errors {
      ...errors
    }
  }
}
    ${A}`;function de(t={}){return $(ce,t)}const pe=async t=>{const{waitForConfirmation:e}=H();if(!await e(__("Are you sure to remove this article?")))return;new D(de({variables:{articleId:t.id}}),{errorNotificationMessage:__("The article could not be deleted.")}).send()},N=t=>t&&t>0,j=(t,e)=>{if(!N(e))return 0;const o=new Date().getTime(),a=new Date(t.createdAt).getTime(),n=(o-a)/1e3;return n>e?0:e-n},me=(t,e)=>{var a,n;const o=M();return!(((a=t.author)==null?void 0:a.id)!==o.userId||(n=t.type)!=null&&n.communication&&!t.internal||N(e)&&!j(t,e))},ue={order:999,addActions(t,e,{onDispose:o,recalculate:a,config:n}){const i=n.ui_ticket_zoom_article_delete_timeframe;if(!me(e,i))return[];const r=j(e,i);if(r){const l=window.setTimeout(()=>{a()},r*1e3);o(()=>{window.clearTimeout(l)})}return[{apps:["mobile","desktop"],label:__("Delete Article"),name:"articleDelete",icon:"trash",perform:()=>pe(e),view:{agent:["change"]}}]}},fe={order:900,addActions(t,e){return[{apps:["desktop"],label:__("Copy article permalink"),name:"article-permalink",icon:"files",view:{agent:["read"],customer:["read"]},link:`/tickets/${t.internalId}/${e.internalId}`,perform:()=>{const{baseUrl:a}=Y(),{copyToClipboard:n}=Z();n(`${a.value}/desktop/tickets/${t.internalId}/${e.internalId}`)}}]}},ye=I`
    mutation ticketArticleChangeVisibility($articleId: ID!, $internal: Boolean!) {
  ticketArticleChangeVisibility(articleId: $articleId, internal: $internal) {
    article {
      id
      internal
    }
    errors {
      ...errors
    }
  }
}
    ${A}`;function ge(t={}){return $(ye,t)}const be=(t,e)=>{const o=e?__("The article could not be set to internal."):__("The article could not be set to public.");return new D(ge({variables:{articleId:t,internal:e}}),{errorNotificationMessage:o}).send()},_e={order:50,addActions(t,e){const o=!e.internal,a=o?__("Set to internal"):__("Set to public");return[{apps:["mobile","desktop"],label:a,name:"changeVisibility",icon:o?"lock":"lock-open",view:{agent:["change"]},perform:()=>be(e.id,o)}]}},he=(t,e)=>{const o=k(()=>ae(t)),a=k(()=>{var r;if(((r=o.value.type)==null?void 0:r.name)!=="email")return;const i=ee(o.value.attachmentsWithoutInline,s=>{var l;return((l=s.preferences)==null?void 0:l["original-format"])===!0});if(i)return`/api/v1/ticket_attachment/${e.value}/${o.value.internalId}/${i.internalId}?disposition=attachment`}),n=k(()=>{var i;if(((i=o.value.type)==null?void 0:i.name)==="email")return`/api/v1/ticket_article_plain/${o.value.internalId}`});return{originalFormattingUrl:a,rawMessageUrl:n}},we=I`
    mutation ticketArticleEmailForwardReply($articleId: ID!, $formId: FormId!) {
  ticketArticleEmailForwardReply(articleId: $articleId, formId: $formId) {
    quotableFrom
    quotableTo
    quotableCc
    attachments {
      id
      internalId
      name
      size
      type
    }
    errors {
      ...errors
    }
  }
}
    ${A}`;function ve(t={}){return $(we,t)}const ke=new D(ve({}),{errorShowNotification:!0}),Te=(t,e)=>{const{quotableFrom:o,quotableCc:a,quotableTo:n}=e||{},r=[[__("Subject"),t.subject],[__("Date"),_.dateTime(t.createdAt)],[__("From"),o],[__("To"),n],[__("CC"),a]].reduce((s,[l,c])=>(c&&s.append(_.t(l),": ",c,document.createElement("br")),s),document.createElement("p"));return r.appendChild(document.createElement("br")),r.outerHTML},Ae=async(t,e,o,a)=>{let n=e.contentType==="text/html"?v(e.bodyWithUrls):T(v(e.bodyWithUrls));n=n.replace(/<p><br><\/p>/g,"<p></p>");const i=await ke.send({formId:o.formId,articleId:e.id}).then(c=>c==null?void 0:c.ticketArticleEmailForwardReply),r=((i==null?void 0:i.attachments)||[]).map((c,d)=>{const m=e.attachmentsWithoutInline[d];if(!m||m.name!==c.name)return c;const{previewUrl:p,inlineUrl:y}=re({internalId:m.internalId,type:c.type},a.api_path);return{...c,preview:p,inline:y}}),s=a.ui_ticket_zoom_article_email_full_quote_header&&i?Te(e,i):"",l=`<p data-marker="signature-before"></p><p>---${_.t("Begin forwarded message")}:---</p><p></p><blockquote type="cite">${s}${n}</blockquote>`;return o.openReplyForm({articleType:"email",subject:a.ui_ticket_zoom_article_email_subject?e.subject||t.title:"",subtype:"forward",attachments:r,body:l})},Ie=t=>{const e={weekday:"long",month:"long",day:"numeric",year:"numeric"};try{return new Date(t).toLocaleTimeString(_.locale(),e)}catch{return new Date(t).toLocaleTimeString("en-US",e)}},$e=(t,e)=>{if(!t.ui_ticket_zoom_article_email_full_quote_header)return"";const o=Ie(e.createdAt),a=e.author.fullname||"";return`${_.t("On %s, %s wrote:",o,a)}<p>
</p>`},De=(t,e,o)=>{if(t!=null&&t.html){const a=t.html;if(a)return{content:a,full:!1}}if(t!=null&&t.text)return{content:T(t.text),full:!1};if(o.ui_ticket_zoom_article_email_full_quote){const a=v(e.bodyWithUrls);return{content:e.contentType==="text/html"?a:T(a),full:!0}}return{content:null,full:!1}},b=t=>{var o;if(!t)return[];const e=(o=t.parsed)==null?void 0:o.filter(a=>!!a.emailAddress);return e!=null&&e.length?e.filter(a=>!a.isSystemAddress).map(a=>a.emailAddress):[]},U=t=>({articleType:"email",subtype:"reply",to:[],cc:[],subject:void 0,body:"",inReplyTo:t.messageId}),Se=(t,e)=>{var n,i,r;const o=U(e);return((n=e.sender)==null?void 0:n.name)===f.Agent?(i=e.to)!=null&&i.raw.includes("@")&&(o.to=b(e.to)):(r=e.from)!=null&&r.raw.includes("@")&&(o.to=b(e.from)),(!o.to.length||o.to.every(s=>!s.includes("@")))&&(o.to=t.customer.email?[t.customer.email]:[]),o},x=t=>t!=null&&t.parsed?t.parsed.some(e=>e.isSystemAddress):!1,w=(t,e,o)=>{const a=e.map(n=>n.toLowerCase()).filter(n=>!(!n||t.has(n)));return o&&a.push(...o),a.forEach(n=>t.add(n)),S(a).map(n=>n.replace(/'(\S+@\S+\.\S+)'/,"$1"))},Ce=(t,e,o)=>{e.from&&(o.to=w(t,b(e.from),o.to)),e.to&&(o.to=w(t,b(e.to),o.to)),e.cc&&(o.cc=w(t,b(e.cc),o.cc))},Fe=(t,e,o=!1)=>{var m,p,y,u;if(((m=e.type)==null?void 0:m.name)==="phone")return Se(t,e);const n=U(e),i=(p=e.sender)==null?void 0:p.name,r=x(e.from),s=x(e.to),l=e.author.email,c=!s&&i===f.Agent&&l&&((u=(y=e.from)==null?void 0:y.parsed)==null?void 0:u.some(g=>{var h;return(h=g.emailAddress)==null?void 0:h.toLowerCase().includes(l)}));r?n.to=b(e.replyTo||e.to):c?n.to=b(e.to):(n.to=b(e.replyTo||e.from),(!n.to.length||n.to.every(g=>!g.includes("@")))&&(n.to=l?[l]:[]));const d=new Set;return n.to.length&&(n.to=w(d,n.to)),o&&Ce(d,e,n),n},R=(t,e,o,a,n=!1)=>{const i=Fe(t,e,n);a.ui_ticket_zoom_article_email_subject&&(i.subject=e.subject||t.title);let{content:r,full:s}=De(o.selection,e,a);if(r){const d=$e(a,e);r=`${s?"":"<p><br><br></p>"}<blockquote type="cite" ${s?'data-marker="signature-before"':""}>${d}${r}</blockquote>`}const l=o.getNewArticleBody("text/html"),c=(r||"")+(l&&r?`<p></p>${l}`:l);o.openReplyForm({...i,subtype:"reply",body:c})},xe=t=>{var a;const e=[t.to,t.cc];((a=t.sender)==null?void 0:a.name)===f.Customer&&e.push(t.from);const o=e.flatMap(n=>(n==null?void 0:n.parsed)||[]).filter(n=>n.emailAddress&&!n.isSystemAddress).map(n=>n.emailAddress);return S(o).length>1},q=async(t,{body:e},o)=>{var s,l;const a=V(),{data:n}=await a.query({variables:{groupId:t.group.id,ticketId:t.id}}),i=(s=n==null?void 0:n.ticketSignature)==null?void 0:s.renderedBody,r=(l=n==null?void 0:n.ticketSignature)==null?void 0:l.id;if(!i||!r){e.removeSignature();return}e.addSignature({body:v(i),id:Q(r),position:o})},Re={order:200,addActions(t,e,{config:o}){var l,c;if(!t.group.emailAddress)return[];const a=(l=e.type)==null?void 0:l.name,n=(c=e.sender)==null?void 0:c.name,i=[],r=a==="email"||a==="web",s=a==="phone"&&(n===f.Customer||n===f.Agent);if((r||s)&&i.push({apps:["mobile","desktop"],name:"email-reply",view:{agent:["change"]},label:__("Reply"),icon:"reply",alwaysVisible:!0,perform:(d,m,p)=>R(d,m,p,o)},{apps:["mobile","desktop"],name:"email-forward",view:{agent:["change"]},label:__("Forward"),icon:"forward",perform:(d,m,p)=>Ae(d,m,p,o)}),r&&xe(e)&&i.push({apps:["mobile","desktop"],name:"email-reply-all",view:{agent:["change"]},label:__("Reply All"),icon:"reply-alt",alwaysVisible:!0,perform:(d,m,p)=>R(d,m,p,o,!0)}),r){const d=he(e,ie(t.internalId));d.originalFormattingUrl.value&&i.push({apps:["desktop"],name:"email-download-original-email",view:{agent:["read"]},label:__("Download original email"),icon:"download",perform:()=>F(d.originalFormattingUrl.value)}),d.rawMessageUrl.value&&i.push({apps:["desktop"],name:"email-download-raw-email",view:{agent:["read"]},label:__("Download raw email"),icon:"download",perform:()=>F(d.rawMessageUrl.value)})}return i},addTypes(t,{config:e}){if(!t.group.emailAddress)return[];const o={to:{required:!0},cc:{},subject:{},body:{required:!0},subtype:{},attachments:{},security:{}};return e.ui_ticket_zoom_article_email_subject||delete o.subject,[{value:"email",label:__("Email"),buttonLabel:__("Add email"),apps:["mobile","desktop"],icon:"mail",view:{agent:["change"]},fields:o,onDeselected(n,{body:i}){V().cancel(),i.removeSignature()},onOpened(n,{body:i}){return q(t,{body:i},1)},onSelected(n,{body:i}){return q(t,{body:i})},internal:!1,performReply(n){return{subtype:"reply",to:n.customer.email?[n.customer.email]:[]}}}]}},qe={order:300,addActions(t,e){var n;const o=(n=e.type)==null?void 0:n.name;return o!=="facebook feed comment"&&o!=="facebook feed post"?[]:[{apps:["mobile","desktop"],label:__("Reply"),name:o,icon:"reply",view:{agent:["change"]},perform(i,r,{openReplyForm:s}){s({articleType:"facebook feed comment",body:"",inReplyTo:null})}}]},addTypes(t){var a;return((a=t.createArticleType)==null?void 0:a.name)!=="facebook feed post"?[]:[{apps:["mobile","desktop"],value:"facebook feed comment",label:__("Facebook"),buttonLabel:__("Add comment"),icon:"facebook",view:{agent:["change"]},fields:{},internal:!1,contentType:"text/plain"}]}},Ee={order:100,addTypes(t,{config:e}){const o=!!e.ui_ticket_zoom_article_note_new_internal;return[{apps:["mobile","desktop"],value:"note",label:__("Note"),buttonLabel:o?__("Add internal note"):__("Add note"),icon:"note",fields:{attachments:{},body:{required:!0}},view:{agent:["change"]},internal:o}]}},Le={order:100,addTypes(){return[{apps:["mobile","desktop"],value:"phone",label:__("Phone"),buttonLabel:__("Add phone call"),icon:"phone",fields:{attachments:{},body:{required:!0}},view:{agent:["change"]},internal:!1}]}},Me={order:300,addActions(t,e){var a,n;return((a=e.sender)==null?void 0:a.name)!==f.Customer||((n=e.type)==null?void 0:n.name)!=="sms"?[]:[{apps:["mobile","desktop"],label:__("Reply"),name:"sms",icon:"reply",view:{agent:["change"]},perform(i,r,{openReplyForm:s}){var d;const l=(d=r.from)==null?void 0:d.raw,c={articleType:"sms",to:l?[l]:[],inReplyTo:r.messageId};s(c)}}]},addTypes(t){var a;return((a=t.createArticleType)==null?void 0:a.name)!=="sms"?[]:[{apps:["mobile","desktop"],value:"sms",label:__("Sms"),buttonLabel:__("Add sms"),icon:"message",view:{agent:["change"]},internal:!1,contentType:"text/plain",fields:{body:{required:!0,validation:"length:1,160"},to:{}},options:{recipientContact:"phone"},editorMeta:{footer:{maxlength:160,warningLength:30}},performReply(n){var r,s;const{preferences:i}=n;return{to:[((r=i==null?void 0:i.sms)==null?void 0:r.originator)||((s=i==null?void 0:i.sms)==null?void 0:s.From)]}}}]}},Pe={order:700,addActions(t,e){return[{apps:["desktop"],label:__("Split"),name:"split",icon:"split",view:{agent:["read"]},link:`/tickets/create?splitTicketArticleId=${encodeURIComponent(e.id)}`}]}},Ve={order:300,addActions(t,e){var i,r;const o=(i=e.sender)==null?void 0:i.name,a=(r=e.type)==null?void 0:r.name;return o!==f.Customer||a!=="telegram personal-message"?[]:[{apps:["mobile","desktop"],label:__("Reply"),name:"telegram personal-message",icon:"reply",view:{agent:["change"]},perform(s,l,{openReplyForm:c}){const d={articleType:a,inReplyTo:l.messageId};c(d)}}]},addTypes(t){var a;return((a=t.createArticleType)==null?void 0:a.name)!=="telegram personal-message"?[]:[{apps:["mobile","desktop"],value:"telegram personal-message",label:__("Telegram"),buttonLabel:__("Add message"),icon:"telegram",view:{agent:["change"]},internal:!1,contentType:"text/plain",fields:{body:{required:!0,validation:"length:1,10000"},attachments:{}},editorMeta:{footer:{maxlength:1e4,warningLength:5e3}}}]}},Be=(t,e,{openReplyForm:o,getNewArticleBody:a})=>{const n={articleType:"twitter status",inReplyTo:e.messageId},i=a("text/plain"),r=e.from?[e.from.raw]:[];e.to&&r.push(e.to.raw);const s=S(r.filter(l=>{var c;return l=l.trim().toLowerCase(),!(i.toLowerCase().includes(l)||l===`@${(c=t.preferences)==null?void 0:c.channel_screen_name}`)})).join(" ");i?n.body=`${s} ${i} `:n.body=`${s} `,o(n)},Ne=(t,e,{openReplyForm:o})=>{var r,s,l,c;const a=(r=e.sender)==null?void 0:r.name;let n;if(a===f.Customer?n=(s=e.from)==null?void 0:s.raw:a===f.Agent&&(n=(l=e.to)==null?void 0:l.raw),!n){const d=(c=e.author.authorizations)==null?void 0:c.find(m=>m.provider==="twitter");n=(d==null?void 0:d.username)||(d==null?void 0:d.uid)}const i={articleType:"twitter direct-message",body:"",to:n?[n]:[],inReplyTo:e.messageId};o(i)},E=t=>{if(t.ui_ticket_zoom_article_twitter_initials){const{user:e}=M();if(e){const{firstname:o,lastname:a,email:n}=e;return`/${G(o,a,n)}`}}return null},je={order:300,addActions(t,e){var n;const o=(n=e.type)==null?void 0:n.name;return o!=="twitter status"&&o!=="twitter direct-message"?[]:[{apps:["mobile","desktop"],label:__("Reply"),name:o,icon:"reply",view:{agent:["change"]},perform(i,r,s){return o==="twitter status"?Be(i,r,s):Ne(i,r,s)}}]},addTypes(t,{config:e}){var r;const o=(r=t.createArticleType)==null?void 0:r.name;if(o!=="twitter status"&&o!=="twitter direct-message")return[];const a={apps:["mobile","desktop"],value:o,label:__("Twitter"),buttonLabel:__("Add message"),icon:"twitter",view:{agent:["change"]},fields:{body:{required:!0},to:{}},internal:!1,contentType:"text/plain",updateForm(s){if(!te(s.article)||ne(s.article))return s;if(typeof s.article.body=="string"){const l=E(e);s.article.body+=l?`
${l}`:""}return s}};let n={};o==="twitter status"&&a.fields.body?(a.fields.body.validation="length:1,280",n={maxlength:280,warningLength:30}):a.fields.to&&a.fields.body&&(a.fields.to.required=!0,a.fields.body.validation="length:1,10000",n={maxlength:1e4,warningLength:500});const i=E(e);return i&&(n.text=i),a.editorMeta={footer:n},[a]}},Ue={order:100,addTypes(){return[{apps:["mobile","desktop"],value:"web",label:__("Web"),buttonLabel:__("Add Reply"),icon:"web",view:{customer:["change"]},fields:{attachments:{}},internal:!1}]}},We={area:X.WhatsAppBusiness,channelAlert(t){var a,n;const e=(n=(a=t.preferences)==null?void 0:a.whatsapp)==null?void 0:n.timestamp_incoming;if(!e||/^(closed|merged|removed)$/.test(t.state.name))return null;const o=new Date(e*1e3);return o.setHours(o.getHours()+24),o<=new Date?{text:__("The 24 hour customer service window is now closed, no further WhatsApp messages can be sent."),variant:"danger"}:{text:__("You have a 24 hour window to send WhatsApp messages in this conversation. The customer service window closes %s."),textPlaceholder:_.relativeDateTime(o.toString()),variant:"warning"}}},ze=Object.assign({"./whatsapp.ts":We}),Oe=Object.values(ze),He=oe(Oe,"area"),Qe=t=>t?He[t]:null,W=[{label:__("Audio file"),types:["audio/aac","audio/mp4","audio/amr","audio/mpeg","audio/ogg"],size:16*1024*1024},{label:__("Sticker file"),types:["image/webp"],size:500*1024},{label:__("Image file"),types:["image/jpeg","image/png"],size:5*1024*1024},{label:__("Video file"),types:["video/mp4","video/3gpp"],size:16*1024*1024},{label:__("Document file"),types:["text/plain","application/pdf","application/vnd.ms-powerpoint","application/msword","application/vnd.ms-excel","application/vnd.openxmlformats-officedocument.wordprocessingml.document","application/vnd.openxmlformats-officedocument.presentationml.presentation","application/vnd.openxmlformats-officedocument.spreadsheetml.sheet"],size:100*1024*1024}],Ge=J(W),L=t=>{const e=Qe(t.initialChannel),o=e==null?void 0:e.channelAlert(t);return!!o&&(o==null?void 0:o.variant)!=="danger"},Je={order:300,addActions(t,e){var i,r;const o=(i=e.sender)==null?void 0:i.name,a=(r=e.type)==null?void 0:r.name;return o!==f.Customer||a!=="whatsapp message"?[]:L(t)?[{apps:["mobile","desktop"],label:__("Reply"),name:"whatsapp message",icon:"reply",alwaysVisible:!0,view:{agent:["change"]},perform(s,l,{openReplyForm:c}){const d={articleType:a,inReplyTo:l.messageId};c(d)}}]:[]},addTypes(t){var m;if(((m=t.createArticleType)==null?void 0:m.name)!=="whatsapp message")return[];if(!L(t))return[];let o,a,n,i;const r=p=>{p.emit("prop:validationVisibility",C.Live),p.store.set(le({key:"bodyNotAllowedForMediaType",blocking:!0,value:_.t("No additional text can be sent with this media type. Please remove the text."),type:"validation",visible:!0}))},s=p=>{p.emit("prop:validationVisibility",C.Submit),p.store.remove("bodyNotAllowedForMediaType")},l=()=>{o&&o.off(a),n&&(n.off(i),s(n))},c=p=>{if(!p)return;const y=u=>{const g=p.getNodeByName("body");g&&(n=g,u&&u.length>0&&u[0].type&&(u[0].type==="image/webp"||u[0].type.startsWith("audio"))?(i=n.on("commit",({payload:h})=>{h?r(n):s(n)}),n.value&&r(n)):(s(n),n.off(i)))};se(K(p.formId,"attachments"),u=>{o=u,o.value&&y(o.value),a=u.on("commit",({payload:g})=>{y(g)})})};return[{apps:["mobile","desktop"],value:"whatsapp message",label:__("WhatsApp"),buttonLabel:__("Add message"),icon:"whatsapp",view:{agent:["change"]},fields:{body:{required:!1,validation:"require_one:attachments|length:1,4096"},attachments:{validation:"require_one:body",accept:Ge,multiple:!1,allowedFiles:W}},internal:!1,contentType:"text/plain",onDeselected:()=>{l()},onSelected:(p,y,u)=>c(u),onOpened:(p,y,u)=>c(u)}]}},Ke=Object.assign({"./articleDelete.ts":ue,"./articlePermalink.ts":fe,"./changeVisibility.ts":_e,"./email.ts":Re,"./facebook.ts":qe,"./note.ts":Ee,"./phone.ts":Le,"./sms.ts":Me,"./split.ts":Pe,"./telegram.ts":Ve,"./twitter.ts":je,"./web.ts":Ue,"./whatsapp.ts":Je}),z=Object.values(Ke).sort((t,e)=>t.order-e.order),O=(t,e)=>o=>{if(!o.apps.includes(e))return!1;const a=o.view[t.view.ticketView];return!a||!a.length?!1:!!(a.includes("read")||t.view.isTicketEditable&&a.includes("change"))},dt=(t,e,o,a)=>{const n=P(),i={...a,view:B(t),config:n.config},r=O(i,o);return z.map(s=>{var l;return((l=s.addActions)==null?void 0:l.call(s,t,e,i))||[]}).flat().filter(r)},pt=(t,e)=>{const o=P(),a={view:B(t),config:o.config},n=O(a,e);return z.map(i=>{var r;return((r=i.addTypes)==null?void 0:r.call(i,t,a))||[]}).flat().filter(n).map(({apps:i,...r})=>({...r,icon:r.icon}))};export{pt as a,dt as c,Qe as g,he as u};
//# sourceMappingURL=index-D5f5eTVX.js.map
