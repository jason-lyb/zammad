{"version":3,"file":"FieldTreeSelectInputDialog-CtooeHyJ.js","sources":["../../../../../app/frontend/apps/mobile/components/Form/fields/FieldTreeSelect/FieldTreeSelectInputDialog.vue"],"sourcesContent":["<!-- Copyright (C) 2012-2025 Zammad Foundation, https://zammad-foundation.org/ -->\n\n<script setup lang=\"ts\">\nimport { escapeRegExp } from 'lodash-es'\nimport { computed, nextTick, onMounted, ref, toRef, watch } from 'vue'\n\nimport CommonInputSearch from '#shared/components/CommonInputSearch/CommonInputSearch.vue'\nimport type { SelectOption } from '#shared/components/CommonSelect/types.ts'\nimport useValue from '#shared/components/Form/composables/useValue.ts'\nimport type {\n  FlatSelectOption,\n  TreeSelectContext,\n} from '#shared/components/Form/fields/FieldTreeSelect/types.ts'\nimport useSelectOptions from '#shared/composables/useSelectOptions.ts'\nimport { useTraverseOptions } from '#shared/composables/useTraverseOptions.ts'\nimport { useLocaleStore } from '#shared/stores/locale.ts'\n\nimport CommonDialog from '#mobile/components/CommonDialog/CommonDialog.vue'\nimport CommonTicketStateIndicator from '#mobile/components/CommonTicketStateIndicator/CommonTicketStateIndicator.vue'\nimport { closeDialog } from '#mobile/composables/useDialog.ts'\n\nconst props = defineProps<{\n  context: TreeSelectContext\n  name: string\n  currentPath: FlatSelectOption[]\n  flatOptions: FlatSelectOption[]\n  sortedOptions: FlatSelectOption[]\n}>()\n\nconst { isCurrentValue } = useValue(toRef(props, 'context'))\n\nconst emit = defineEmits<{\n  push: [FlatSelectOption]\n  pop: []\n}>()\n\nconst locale = useLocaleStore()\n\nconst currentParent = computed(\n  () => props.currentPath[props.currentPath.length - 1] ?? null,\n)\n\nconst filter = ref('')\nconst filterInput = ref<HTMLInputElement>()\n\nconst clearFilter = () => {\n  filter.value = ''\n}\n\nconst close = () => {\n  closeDialog(props.name)\n  clearFilter()\n}\n\nconst pushToPath = (option: FlatSelectOption) => {\n  emit('push', option)\n}\n\nconst popFromPath = () => {\n  emit('pop')\n}\n\nconst contextReactive = toRef(props, 'context')\n\nwatch(() => contextReactive.value.noFiltering, clearFilter)\n\nconst focusFirstTarget = (targetElements?: HTMLElement[]) => {\n  if (!targetElements || !targetElements.length) return\n\n  targetElements[0].focus()\n}\n\nconst {\n  dialog,\n  getSelectedOptionLabel,\n  selectOption,\n  getDialogFocusTargets,\n  getSelectedOption,\n} = useSelectOptions(toRef(props, 'flatOptions'), contextReactive)\n\nconst previousPageCallback = () => {\n  popFromPath()\n  clearFilter()\n  nextTick(() => focusFirstTarget(getDialogFocusTargets(true)))\n}\n\nconst nextPageCallback = (option?: SelectOption | FlatSelectOption) => {\n  if (option && (option as FlatSelectOption).hasChildren) {\n    pushToPath(option as FlatSelectOption)\n    nextTick(() => focusFirstTarget(getDialogFocusTargets(true)))\n  }\n}\n\nuseTraverseOptions(() => dialog.value?.parentElement, {\n  filterOption: (el) => el.tagName !== 'INPUT',\n  direction: 'vertical',\n  onArrowRight() {\n    const focusedOption = document.activeElement as HTMLElement\n    const { value } = focusedOption?.dataset || {}\n    const option = value ? getSelectedOption(value) : undefined\n    nextPageCallback(option)\n    return false\n  },\n  onArrowLeft() {\n    previousPageCallback()\n    return false\n  },\n})\n\nconst deaccent = (s: string) =>\n  s.normalize('NFD').replace(/[\\u0300-\\u036f]/g, '')\n\nconst filteredOptions = computed(() => {\n  // In case we are not currently filtering for a parent, search across all options.\n  let options = props.sortedOptions\n\n  // Otherwise, search across options which are children of the current parent.\n  if (currentParent.value)\n    options = props.sortedOptions.filter((option) =>\n      option.parents.includes(currentParent.value?.value),\n    )\n\n  // Trim and de-accent search keywords and compile them as a case-insensitive regex.\n  //   Make sure to escape special regex characters!\n  const filterRegex = new RegExp(\n    escapeRegExp(deaccent(filter.value.trim())),\n    'i',\n  )\n\n  // Search across options via their de-accented labels.\n  return options.filter((option) =>\n    filterRegex.test(deaccent(option.label || String(option.value))),\n  )\n})\n\nconst select = (option: FlatSelectOption) => {\n  if (props.context.disabled) return\n  selectOption(option)\n  if (!props.context.multiple) close()\n}\n\nconst currentOptions = computed(() => {\n  // In case we are not currently filtering for a parent, return only top-level options.\n  if (!currentParent.value)\n    return props.sortedOptions.filter((option) => !option.parents?.length)\n\n  // Otherwise, return all options which are children of the current parent.\n  return props.sortedOptions.filter(\n    (option) =>\n      option.parents.length &&\n      option.parents[option.parents.length - 1] === currentParent.value?.value,\n  )\n})\n\nconst goToPreviousPage = () => {\n  previousPageCallback()\n}\n\nconst goToNextPage = (option: FlatSelectOption) => {\n  if (props.context.disabled) return\n  nextPageCallback(option)\n}\n\nconst selectAndClose = (option: FlatSelectOption) => {\n  if (props.context.disabled) return\n  select(option)\n  // \"Enter\" always closes the dialog after selection: https://www.w3.org/WAI/ARIA/apg/patterns/menubar/\n  close()\n}\n\nonMounted(() => {\n  filterInput.value?.focus()\n})\n\nconst getCurrentIndex = (option: FlatSelectOption) => {\n  return props.flatOptions.findIndex((o) => o.value === option.value)\n}\n</script>\n\n<template>\n  <CommonDialog :name=\"name\" :label=\"context.label\" @close=\"close\">\n    <div class=\"w-full p-4\">\n      <CommonInputSearch\n        v-if=\"!context.noFiltering\"\n        ref=\"filterInput\"\n        v-model=\"filter\"\n      />\n    </div>\n    <div\n      v-if=\"currentPath.length\"\n      :class=\"{\n        'px-6': !context.noFiltering,\n      }\"\n      class=\"focus:bg-blue-highlight flex h-[58px] cursor-pointer items-center self-stretch px-4 py-5 text-base leading-[19px] text-white focus:outline-hidden\"\n      tabindex=\"0\"\n      role=\"button\"\n      :aria-label=\"$t('Back to previous page')\"\n      @click=\"goToPreviousPage()\"\n      @keypress.space.prevent=\"goToPreviousPage()\"\n    >\n      <CommonIcon\n        size=\"base\"\n        class=\"ltr:mr-3 rtl:ml-3\"\n        :name=\"`chevron-${locale.localeData?.dir === 'rtl' ? 'right' : 'left'}`\"\n      />\n      <span class=\"grow font-semibold text-white/80\">\n        {{ currentParent.label || currentParent.value }}\n      </span>\n    </div>\n    <!-- https://www.w3.org/WAI/ARIA/apg/patterns/listbox/ -->\n    <div\n      v-if=\"filter ? filteredOptions.length : currentOptions.length\"\n      ref=\"dialog\"\n      :class=\"{\n        'border-t border-white/30': currentPath.length,\n      }\"\n      :aria-label=\"$t('Selectâ€¦')\"\n      class=\"flex grow flex-col items-start self-stretch overflow-y-auto\"\n      role=\"listbox\"\n      :aria-multiselectable=\"context.multiple\"\n    >\n      <div\n        v-for=\"(option, index) in filter ? filteredOptions : currentOptions\"\n        :id=\"`${name}-${option.value}`\"\n        :key=\"String(option.value)\"\n        :class=\"{\n          'px-6': !context.noFiltering,\n          'pointer-events-none': option.disabled,\n        }\"\n        class=\"focus:bg-blue-highlight relative flex h-[58px] cursor-pointer items-center self-stretch px-4 py-5 text-base leading-[19px] text-white focus:outline-hidden\"\n        tabindex=\"0\"\n        role=\"option\"\n        :aria-selected=\"\n          option.disabled ? undefined : isCurrentValue(option.value)\n        \"\n        :aria-setsize=\"flatOptions.length\"\n        :aria-posinset=\"getCurrentIndex(option) + 1\"\n        :data-value=\"option.value\"\n        :aria-haspopup=\"option.hasChildren && !filter ? 'menu' : 'false'\"\n        :aria-expanded=\"option.hasChildren && !filter ? 'false' : undefined\"\n        :aria-disabled=\"option.disabled ? 'true' : undefined\"\n        @click=\"select(option)\"\n        @keyup.enter.prevent=\"selectAndClose(option)\"\n        @keypress.space.prevent=\"select(option)\"\n      >\n        <div\n          v-if=\"index !== 0\"\n          :class=\"{\n            'ltr:left-4 rtl:right-4':\n              !context.multiple && !option.icon && !option.status,\n            'ltr:left-[50px] rtl:right-[50px]':\n              !context.multiple && option.icon && !option.status,\n            'ltr:left-[58px] rtl:right-[58px]':\n              !context.multiple && !option.icon && option.status,\n            'ltr:left-[60px] rtl:right-[60px]':\n              context.multiple && !option.icon && !option.status,\n            'ltr:left-[88px] rtl:right-[88px]':\n              context.multiple && option.icon && !option.status,\n            'ltr:left-[94px] rtl:right-[94px]':\n              context.multiple && !option.icon && option.status,\n          }\"\n          class=\"absolute top-0 h-0 border-t border-white/10 ltr:right-4 rtl:left-4\"\n        />\n        <CommonIcon\n          v-if=\"context.multiple\"\n          :class=\"{\n            '!text-white': isCurrentValue(option.value),\n            'opacity-30': option.disabled,\n          }\"\n          :name=\"\n            isCurrentValue(option.value) ? 'check-box-yes' : 'check-box-no'\n          \"\n          size=\"base\"\n          decorative\n          class=\"text-white/50 ltr:mr-3 rtl:ml-3\"\n        />\n        <CommonTicketStateIndicator\n          v-if=\"option.status\"\n          :color-code=\"option.status\"\n          :label=\"option.label || String(option.value)\"\n          :class=\"{\n            'opacity-30': option.disabled,\n          }\"\n          class=\"ltr:mr-[11px] rtl:ml-[11px]\"\n        />\n        <CommonIcon\n          v-else-if=\"option.icon\"\n          :name=\"option.icon\"\n          :class=\"{\n            '!text-white': isCurrentValue(option.value),\n            'opacity-30': option.disabled,\n          }\"\n          size=\"small\"\n          class=\"text-white/80 ltr:mr-[11px] rtl:ml-[11px]\"\n        />\n        <span\n          :class=\"{\n            'font-semibold !text-white': isCurrentValue(option.value),\n            'opacity-30': option.disabled,\n          }\"\n          class=\"grow text-white/80\"\n        >\n          {{ option.label || option.value }}\n          <template v-if=\"filter\">\n            <span\n              v-for=\"(parentValue, parentIndex) in (option as FlatSelectOption)\n                .parents\"\n              :key=\"String(parentValue)\"\n              class=\"text-gray\"\n            >\n              <template v-if=\"parentIndex === 0\"> â€” </template>\n              <template v-else> â€º </template>\n              {{\n                getSelectedOptionLabel(parentValue) ||\n                i18n.t('%s (unknown)', parentValue.toString())\n              }}\n            </span>\n          </template>\n        </span>\n        <CommonIcon\n          v-if=\"!context.multiple && isCurrentValue(option.value)\"\n          :class=\"{\n            'opacity-30': option.disabled,\n            'ltr:mr-3 rtl:ml-3': option.hasChildren,\n          }\"\n          size=\"tiny\"\n          decorative\n          name=\"check\"\n        />\n        <CommonIcon\n          v-if=\"option.hasChildren && !filter\"\n          class=\"pointer-events-auto\"\n          size=\"base\"\n          :name=\"`chevron-${\n            locale.localeData?.dir === 'rtl' ? 'left' : 'right'\n          }`\"\n          role=\"link\"\n          :label=\"$t('Has submenu')\"\n          @click.stop=\"goToNextPage(option)\"\n        />\n      </div>\n    </div>\n    <div\n      v-if=\"filter && !filteredOptions.length\"\n      class=\"relative flex h-[58px] items-center justify-center self-stretch px-4 py-5 text-base leading-[19px] text-white/50\"\n      role=\"alert\"\n    >\n      {{ $t('No results found') }}\n    </div>\n  </CommonDialog>\n</template>\n"],"names":["props","__props","isCurrentValue","useValue","toRef","emit","__emit","locale","useLocaleStore","currentParent","computed","filter","ref","filterInput","clearFilter","close","closeDialog","pushToPath","option","popFromPath","contextReactive","watch","focusFirstTarget","targetElements","dialog","getSelectedOptionLabel","selectOption","getDialogFocusTargets","getSelectedOption","useSelectOptions","previousPageCallback","nextTick","nextPageCallback","useTraverseOptions","_a","el","focusedOption","value","deaccent","s","filteredOptions","options","filterRegex","escapeRegExp","select","currentOptions","goToPreviousPage","goToNextPage","selectAndClose","onMounted","getCurrentIndex","o"],"mappings":"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"}