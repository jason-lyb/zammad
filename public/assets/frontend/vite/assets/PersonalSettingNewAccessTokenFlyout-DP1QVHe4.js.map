{"version":3,"file":"PersonalSettingNewAccessTokenFlyout-DP1QVHe4.js","sources":["../../../../../app/frontend/shared/entities/user/current/graphql/mutations/userCurrentAccessTokenAdd.api.ts","../../../../../app/frontend/apps/desktop/pages/personal-setting/components/PersonalSettingNewAccessTokenFlyout.vue"],"sourcesContent":["import * as Types from '#shared/graphql/types.ts';\n\nimport gql from 'graphql-tag';\nimport { TokenAttributesFragmentDoc } from '../fragments/tokenAttributes.api';\nimport { ErrorsFragmentDoc } from '../../../../../graphql/fragments/errors.api';\nimport * as VueApolloComposable from '@vue/apollo-composable';\nimport * as VueCompositionApi from 'vue';\nexport type ReactiveFunction<TParam> = () => TParam;\n\nexport const UserCurrentAccessTokenAddDocument = gql`\n    mutation userCurrentAccessTokenAdd($input: UserAccessTokenInput!) {\n  userCurrentAccessTokenAdd(input: $input) {\n    token {\n      ...tokenAttributes\n    }\n    tokenValue\n    errors {\n      ...errors\n    }\n  }\n}\n    ${TokenAttributesFragmentDoc}\n${ErrorsFragmentDoc}`;\nexport function useUserCurrentAccessTokenAddMutation(options: VueApolloComposable.UseMutationOptions<Types.UserCurrentAccessTokenAddMutation, Types.UserCurrentAccessTokenAddMutationVariables> | ReactiveFunction<VueApolloComposable.UseMutationOptions<Types.UserCurrentAccessTokenAddMutation, Types.UserCurrentAccessTokenAddMutationVariables>> = {}) {\n  return VueApolloComposable.useMutation<Types.UserCurrentAccessTokenAddMutation, Types.UserCurrentAccessTokenAddMutationVariables>(UserCurrentAccessTokenAddDocument, options);\n}\nexport type UserCurrentAccessTokenAddMutationCompositionFunctionResult = VueApolloComposable.UseMutationReturn<Types.UserCurrentAccessTokenAddMutation, Types.UserCurrentAccessTokenAddMutationVariables>;","<!-- Copyright (C) 2012-2025 Zammad Foundation, https://zammad-foundation.org/ -->\n\n<script setup lang=\"ts\">\nimport { computed, ref } from 'vue'\n\nimport Form from '#shared/components/Form/Form.vue'\nimport type { FormSubmitData } from '#shared/components/Form/types.ts'\nimport { useForm } from '#shared/components/Form/useForm.ts'\nimport { useUserCurrentAccessTokenAddMutation } from '#shared/entities/user/current/graphql/mutations/userCurrentAccessTokenAdd.api.ts'\nimport { UserCurrentAccessTokenListDocument } from '#shared/entities/user/current/graphql/queries/userCurrentAcessTokenList.api.ts'\nimport { defineFormSchema } from '#shared/form/defineFormSchema.ts'\nimport {\n  EnumFormUpdaterId,\n  type UserCurrentAccessTokenListQuery,\n} from '#shared/graphql/types.ts'\nimport MutationHandler from '#shared/server/apollo/handler/MutationHandler.ts'\n\nimport CommonFlyout from '#desktop/components/CommonFlyout/CommonFlyout.vue'\nimport type { ActionFooterOptions } from '#desktop/components/CommonFlyout/types.ts'\nimport { closeFlyout } from '#desktop/components/CommonFlyout/useFlyout.ts'\nimport CommonInputCopyToClipboard from '#desktop/components/CommonInputCopyToClipboard/CommonInputCopyToClipboard.vue'\n\nimport type { NewTokenAccessFormData } from '../types/token-access.ts'\n\nconst { form } = useForm()\n\nconst formSchema = defineFormSchema([\n  {\n    type: 'text',\n    name: 'name',\n    label: __('Name'),\n    required: true,\n  },\n  {\n    type: 'date',\n    name: 'expires_at',\n    label: __('Expiration date'),\n    props: {\n      futureOnly: true,\n    },\n  },\n  {\n    type: 'permissions',\n    name: 'permissions',\n    label: 'Permissions',\n    props: {\n      options: [],\n    },\n    required: true,\n  },\n])\n\nconst accessTokenCreateMutation = new MutationHandler(\n  useUserCurrentAccessTokenAddMutation({\n    update: (cache, { data }) => {\n      if (!data) return\n\n      const { userCurrentAccessTokenAdd } = data\n      if (!userCurrentAccessTokenAdd?.token) return\n\n      let existingAccessTokens =\n        cache.readQuery<UserCurrentAccessTokenListQuery>({\n          query: UserCurrentAccessTokenListDocument,\n        })\n\n      const newIdPresent =\n        existingAccessTokens?.userCurrentAccessTokenList?.find((token) => {\n          return token.id === userCurrentAccessTokenAdd.token?.id\n        })\n      if (newIdPresent) return\n\n      existingAccessTokens = {\n        ...existingAccessTokens,\n        userCurrentAccessTokenList: [\n          userCurrentAccessTokenAdd.token,\n          ...(existingAccessTokens?.userCurrentAccessTokenList || []),\n        ],\n      }\n\n      cache.writeQuery({\n        query: UserCurrentAccessTokenListDocument,\n        data: existingAccessTokens,\n      })\n    },\n  }),\n  {\n    errorNotificationMessage: __('The access token could not be created.'),\n  },\n)\n\nconst accessToken = ref<string>('')\n\nconst submitForm = (data: FormSubmitData<NewTokenAccessFormData>) => {\n  return accessTokenCreateMutation\n    .send({\n      input: {\n        name: data.name,\n        expiresAt: data.expires_at,\n        permission: data.permissions,\n      },\n    })\n    .then((result) => {\n      if (result?.userCurrentAccessTokenAdd?.tokenValue) {\n        accessToken.value = result.userCurrentAccessTokenAdd.tokenValue\n      }\n    })\n}\n\nconst footerActionOptions = computed<ActionFooterOptions>(() => {\n  if (accessToken.value) {\n    return {\n      actionLabel: __('OK, I have copied my token'),\n      actionButton: { variant: 'primary' },\n      hideCancelButton: true,\n    }\n  }\n\n  return {\n    actionLabel: __('Create'),\n    actionButton: { variant: 'submit', type: 'submit' },\n    form: form.value,\n  }\n})\n\nconst actionCloseFlyout = () => {\n  if (accessToken.value) closeFlyout('new-access-token')\n}\n</script>\n\n<template>\n  <CommonFlyout\n    :header-title=\"__('New Personal Access Token')\"\n    :footer-action-options=\"footerActionOptions\"\n    header-icon=\"key\"\n    no-close-on-action\n    name=\"new-access-token\"\n    @action=\"actionCloseFlyout()\"\n    @activated=\"form?.triggerFormUpdater\"\n  >\n    <div v-if=\"accessToken\" class=\"flex flex-col gap-3\">\n      <CommonLabel>{{\n        $t(\n          \"For security reasons, the API token is shown only once. You'll need to save it somewhere secure before continuing.\",\n        )\n      }}</CommonLabel>\n      <CommonInputCopyToClipboard\n        :value=\"accessToken\"\n        :label=\"__('Your Personal Access Token')\"\n        :copy-button-text=\"__('Copy Token')\"\n      />\n    </div>\n    <Form\n      v-else\n      ref=\"form\"\n      :schema=\"formSchema\"\n      :form-updater-id=\"\n        EnumFormUpdaterId.FormUpdaterUpdaterUserCurrentNewAccessToken\n      \"\n      form-updater-initial-only\n      should-autofocus\n      @submit=\"submitForm($event as FormSubmitData<NewTokenAccessFormData>)\"\n    />\n  </CommonFlyout>\n</template>\n"],"names":["UserCurrentAccessTokenAddDocument","gql","TokenAttributesFragmentDoc","ErrorsFragmentDoc","useUserCurrentAccessTokenAddMutation","options","VueApolloComposable.useMutation","form","useForm","formSchema","defineFormSchema","accessTokenCreateMutation","MutationHandler","cache","data","userCurrentAccessTokenAdd","existingAccessTokens","UserCurrentAccessTokenListDocument","_a","token","accessToken","ref","submitForm","result","footerActionOptions","computed","actionCloseFlyout","closeFlyout"],"mappings":"2sDASO,MAAMA,EAAoCC;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA;AAAA,MAY3CC,CAA0B;AAAA,EAC9BC,CAAiB,GACH,SAAAC,EAAqCC,EAAmS,GAAI,CACnV,OAAAC,EAA2HN,EAAmCK,CAAO,CAC9K,yGCDM,KAAA,CAAE,KAAAE,GAASC,IAEXC,EAAaC,EAAiB,CAClC,CACE,KAAM,OACN,KAAM,OACN,MAAO,GAAG,MAAM,EAChB,SAAU,EACZ,EACA,CACE,KAAM,OACN,KAAM,aACN,MAAO,GAAG,iBAAiB,EAC3B,MAAO,CACL,WAAY,EACd,CACF,EACA,CACE,KAAM,cACN,KAAM,cACN,MAAO,cACP,MAAO,CACL,QAAS,CAAC,CACZ,EACA,SAAU,EACZ,CAAA,CACD,EAEKC,EAA4B,IAAIC,EACpCR,EAAqC,CACnC,OAAQ,CAACS,EAAO,CAAE,KAAAC,KAAW,OAC3B,GAAI,CAACA,EAAM,OAEL,KAAA,CAAE,0BAAAC,CAA8B,EAAAD,EAClC,GAAA,EAACC,GAAA,MAAAA,EAA2B,OAAO,OAEnC,IAAAC,EACFH,EAAM,UAA2C,CAC/C,MAAOI,CAAA,CACR,GAGDC,EAAAF,GAAA,YAAAA,EAAsB,6BAAtB,MAAAE,EAAkD,KAAMC,GAAU,OACzD,OAAAA,EAAM,OAAOD,EAAAH,EAA0B,QAA1B,YAAAG,EAAiC,GAAA,KAIlCF,EAAA,CACrB,GAAGA,EACH,2BAA4B,CAC1BD,EAA0B,MAC1B,IAAIC,GAAA,YAAAA,EAAsB,6BAA8B,CAAC,CAC3D,CAAA,EAGFH,EAAM,WAAW,CACf,MAAOI,EACP,KAAMD,CAAA,CACP,EACH,CAAA,CACD,EACD,CACE,yBAA0B,GAAG,wCAAwC,CACvE,CAAA,EAGII,EAAcC,EAAY,EAAE,EAE5BC,EAAcR,GACXH,EACJ,KAAK,CACJ,MAAO,CACL,KAAMG,EAAK,KACX,UAAWA,EAAK,WAChB,WAAYA,EAAK,WACnB,CAAA,CACD,EACA,KAAMS,GAAW,QACZL,EAAAK,GAAA,YAAAA,EAAQ,4BAAR,MAAAL,EAAmC,aACzBE,EAAA,MAAQG,EAAO,0BAA0B,WACvD,CACD,EAGCC,EAAsBC,EAA8B,IACpDL,EAAY,MACP,CACL,YAAa,GAAG,4BAA4B,EAC5C,aAAc,CAAE,QAAS,SAAU,EACnC,iBAAkB,EAAA,EAIf,CACL,YAAa,GAAG,QAAQ,EACxB,aAAc,CAAE,QAAS,SAAU,KAAM,QAAS,EAClD,KAAMb,EAAK,KAAA,CAEd,EAEKmB,EAAoB,IAAM,CAC1BN,EAAY,OAAOO,EAAY,kBAAkB,CAAA"}